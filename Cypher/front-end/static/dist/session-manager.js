class a{constructor(){this.accessToken=null,this.refreshToken=null,this.refreshTimeout=null,this.isRefreshing=!1,this.refreshPromise=null,this.setupStorageSync()}setupStorageSync(){window.addEventListener("storage",e=>{if(e.key==="refresh_token")this.refreshToken=e.newValue;else if(e.key==="token_sync"){const s=JSON.parse(e.newValue||"{}");if(s.action==="update"){this.accessToken=this.getCookie("access_token"),this.refreshTimeout&&clearTimeout(this.refreshTimeout);const t=720,r=Math.random()*60;this.scheduleRefresh(t+r)}else s.action==="clear"&&this.clearSession()}})}setCookie(e,s,t){const r=location.protocol==="https:"?"; Secure":"",o=`${e}=${s}; Max-Age=${t}; SameSite=Lax; Path=/${r}`;document.cookie=o}getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return t.length===2?t.pop().split(";").shift():null}deleteCookie(e){document.cookie=`${e}=; Max-Age=0; Path=/; SameSite=Lax`}setTokens(e,s,t){this.accessToken=e,this.refreshToken=s,this.setCookie("access_token",e,t),localStorage.setItem("refresh_token",s),localStorage.setItem("token_sync",JSON.stringify({action:"update",timestamp:Date.now()}));const r=720,o=Math.random()*60;this.scheduleRefresh(r+o)}loadTokens(){return this.accessToken=this.getCookie("access_token"),this.refreshToken=localStorage.getItem("refresh_token"),this.accessToken&&this.refreshToken&&this.verifyToken().catch(()=>{this.refreshTokens()}),this.hasValidSession()}hasValidSession(){return!!(this.accessToken&&this.refreshToken)}getAccessToken(){return this.accessToken}scheduleRefresh(e){this.refreshTimeout&&clearTimeout(this.refreshTimeout),this.refreshTimeout=setTimeout(()=>{this.refreshTokens()},e*1e3)}async refreshTokens(){if(this.isRefreshing)return this.refreshPromise;if(!this.refreshToken)throw new Error("No refresh token available");if(!this.acquireRefreshLock())return new Promise(s=>{const t=r=>{r.key==="token_sync"&&JSON.parse(r.newValue||"{}").action==="update"&&(this.accessToken=this.getCookie("access_token"),this.refreshToken=localStorage.getItem("refresh_token"),window.removeEventListener("storage",t),s())};window.addEventListener("storage",t),setTimeout(()=>{window.removeEventListener("storage",t),s()},1e4)});this.isRefreshing=!0,this.refreshPromise=this._performRefresh();try{return await this.refreshPromise}finally{this.isRefreshing=!1,this.refreshPromise=null,this.releaseRefreshLock()}}acquireRefreshLock(){const e=Date.now(),s=Math.random().toString(36),t=JSON.stringify({timestamp:e,tabId:s});localStorage.setItem("refresh_lock",t);const r=localStorage.getItem("refresh_lock");if(r!==t){try{const o=JSON.parse(r);if(e-o.timestamp>1e4)return localStorage.setItem("refresh_lock",t),localStorage.getItem("refresh_lock")===t}catch{return localStorage.setItem("refresh_lock",t),localStorage.getItem("refresh_lock")===t}return!1}return!0}releaseRefreshLock(){localStorage.removeItem("refresh_lock")}async _performRefresh(){try{const e=await fetch("/api/refresh-token",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({refresh_token:this.refreshToken})});if(!e.ok)throw new Error("Token refresh failed");const s=await e.json();if(s.success)return this.setTokens(s.access_token,s.refresh_token,s.expires_in),s;throw new Error(s.error||"Token refresh failed")}catch(e){throw this.clearSession(),e}}async verifyToken(){if(!this.accessToken)throw new Error("No access token");const s=await(await fetch("/api/verify-access",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({access_token:this.accessToken})})).json();if(!s.valid)throw new Error(s.error||"Token invalid");return s}async authenticatedFetch(e,s={}){if(!this.accessToken)throw new Error("No access token - user not authenticated");const t=s.body?JSON.parse(s.body):{};t.access_token=this.accessToken;const r={...s,headers:{"Content-Type":"application/json",...s.headers},body:JSON.stringify(t)};try{const o=await fetch(e,r);if(o.status===401){await this.refreshTokens();const n=JSON.parse(r.body);return n.access_token=this.accessToken,r.body=JSON.stringify(n),fetch(e,r)}return o}catch(o){throw o}}async logout(){try{await fetch("/api/logout",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({access_token:this.accessToken,refresh_token:this.refreshToken})})}finally{this.clearSession()}}clearSession(){this.accessToken=null,this.refreshToken=null,this.deleteCookie("access_token"),localStorage.removeItem("refresh_token"),localStorage.removeItem("refresh_lock"),localStorage.setItem("token_sync",JSON.stringify({action:"clear",timestamp:Date.now()})),this.refreshTimeout&&(clearTimeout(this.refreshTimeout),this.refreshTimeout=null)}async getCurrentUser(){if(!this.accessToken)return null;try{const e=await this.verifyToken();return{username:e.username,sessionId:e.session_id}}catch{return null}}}const i=new a;window.sessionManager=i;document.addEventListener("DOMContentLoaded",()=>{i.loadTokens()});export{a as SessionManager,i as sessionManager};
