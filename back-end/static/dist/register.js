import{g as P,O as I,a as x,R as C}from"./opaque_client.js";const w=P(I.OPAQUE_P256),O=[{id:"input",title:"Password Input",description:"Your password is entered locally and never transmitted",icon:"bi-keyboard",dataFlow:null},{id:"validation",title:"Input Validation",description:"Validating password strength and confirmation",icon:"bi-check-circle",dataFlow:null},{id:"generate-keys",title:"Generate Keys",description:"Creating cryptographic keypair for secure registration",icon:"bi-cpu",dataFlow:null},{id:"registration-request",title:"Registration Request",description:"Sending encrypted registration data to server",icon:"bi-arrow-up-circle",dataFlow:"Registration Request → Server"},{id:"server-response",title:"Server Response",description:"Server processing registration with OPAQUE protocol",icon:"bi-server",dataFlow:"Registration Response ← Server"},{id:"finalize",title:"Finalize Registration",description:"Completing OPAQUE protocol and storing credentials",icon:"bi-shield-check",dataFlow:null},{id:"totp-setup",title:"2FA Setup",description:"Configuring time-based authentication",icon:"bi-shield-lock",dataFlow:null},{id:"totp-verify",title:"Verify 2FA",description:"Confirming TOTP code functionality",icon:"bi-check-circle-fill",dataFlow:null},{id:"success",title:"Registration Complete",description:"Account created successfully with 2FA enabled",icon:"bi-check-circle-fill",dataFlow:null}];class k{constructor(){this.steps=O,this.init()}init(){this.renderSteps()}renderSteps(){const s=document.getElementById("live-steps");s&&(s.innerHTML=this.steps.map((e,a)=>`
            <div class="live-step" id="step-${e.id}">
                <div class="step-icon">
                    <i class="${e.icon}"></i>
                </div>
                <div class="step-content">
                    <div class="step-title">${e.title}</div>
                    <div class="step-description">${e.description}</div>
                    ${e.dataFlow?`<div class="data-flow">${e.dataFlow}</div>`:""}
                </div>
            </div>
        `).join(""))}activateStep(s){const e=this.steps.findIndex(a=>a.id===s);this.steps.forEach((a,c)=>{const n=document.getElementById(`step-${a.id}`);n&&(n.className=n.className.replace(/\b(active|processing|completed)\b/g,"").trim(),c<e?n.classList.add("completed"):c===e&&n.classList.add("active"))})}completeStep(s){const e=document.getElementById(`step-${s}`);e&&(e.classList.remove("active","processing"),e.classList.add("completed"))}updateSecurityStatus(s,e="success"){const a=document.getElementById("security-status");if(a){const c=e==="success"?"bi-shield-check":"bi-shield-exclamation",n=e==="success"?"text-success":"text-warning";a.innerHTML=`
                <div class="d-flex align-items-center">
                    <i class="${c} ${n} me-2"></i>
                    <span class="text-white">${s}</span>
                </div>
            `}}}let t;function F(){const r=document.getElementById("hide-sidebar"),s=document.getElementById("show-sidebar"),e=document.getElementById("visualization-panel");r&&s&&e&&(r.addEventListener("click",()=>{e.classList.add("hidden"),s.style.display="block"}),s.addEventListener("click",()=>{e.classList.remove("hidden"),s.style.display="none"}))}function m(r,s="success"){const e=document.getElementById("alert-container"),a=s==="success"?"alert-success":"alert-danger",c=s==="success"?"bi-check-circle-fill":"bi-exclamation-triangle-fill";e.innerHTML=`
        <div class="alert ${a} alert-dismissible fade show" role="alert">
            <i class="${c} me-2"></i>
            ${r}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `,s==="success"&&setTimeout(()=>{const n=e.querySelector(".alert");n&&new bootstrap.Alert(n).close()},5e3)}function b(){const r=document.getElementById("alert-container");r.innerHTML=""}function L(r,s){return r!==s?(m("Passwords do not match!","error"),!1):r.length<8?(m("Password must be at least 8 characters long!","error"),!1):!0}document.addEventListener("DOMContentLoaded",async()=>{t=new k,F();const r=document.getElementById("register-form");r&&r.addEventListener("submit",async o=>{o.preventDefault(),b(),t.activateStep("input"),t.updateSecurityStatus("Password entered locally - never transmitted in plaintext");const l=new FormData(r),i=l.get("username"),p=l.get("password"),f=l.get("confirm_password");if(!i||!p||!f){m("Please fill in all fields!","error");return}if(t.activateStep("validation"),await new Promise(u=>setTimeout(u,500)),!L(p,f))return;t.completeStep("validation");const d=r.querySelector('button[type="submit"]'),y=d.textContent;d.disabled=!0,d.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status"></span>Registering...';try{t.activateStep("generate-keys"),t.updateSecurityStatus("Generating cryptographic blinding - your password stays secure"),await new Promise(g=>setTimeout(g,800));const u=new x(w),S=(await u.registerInit(p)).serialize();t.completeStep("generate-keys"),t.activateStep("registration-request"),t.updateSecurityStatus("Sending blinded password to server - original password never leaves this device");const v=await fetch("http://localhost:3000/register/init",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i,registrationRequest:S})});if(!v.ok){const g=await v.json();throw new Error(g.error||"Registration failed")}t.completeStep("registration-request"),t.activateStep("server-response"),t.updateSecurityStatus("Server processing blinded password - your actual password remains unknown");const{registrationResponse:T}=await v.json(),E=C.deserialize(w,T);t.completeStep("server-response"),t.activateStep("finalize"),t.updateSecurityStatus("Creating your secure credential file locally"),await new Promise(g=>setTimeout(g,600));const R=(await u.registerFinish(E)).record.serialize();t.completeStep("finalize");const h=await fetch("http://localhost:3000/register/finish",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i,record:R})});if(!h.ok){const g=await h.json();throw new Error(g.error||"Registration completion failed")}if((await h.json()).success)t.activateStep("totp-setup"),t.updateSecurityStatus("OPAQUE registration complete! Now setting up 2FA..."),document.getElementById("register-form").parentElement.style.display="none",document.getElementById("totp-phase").style.display="block",document.getElementById("back-link").style.display="none",s(),m("OPAQUE registration successful! Please set up 2FA to complete registration.","success");else throw new Error("Registration failed - please try again")}catch(u){console.error("Registration error:",u),m(`Registration failed: ${u.message}`,"error")}finally{d.disabled=!1,d.textContent=y}});async function s(){try{const o=document.getElementById("username").value,l=await fetch("http://localhost:3000/totp/setup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:o})});if(!l.ok)throw new Error("Failed to setup TOTP");const i=await l.json();return document.getElementById("totp-secret").textContent=i.secret,window.currentUsername=o,e(i.qrCode,i.otpauthUrl),a(i.secret),i.secret}catch(o){throw console.error("TOTP setup error:",o),m(`TOTP setup failed: ${o.message}`,"error"),o}}function e(o,l){const i=document.getElementById("qr-code");i.innerHTML=`
            <div class="text-center p-4" style="background: rgba(255,255,255,0.1); border-radius: 8px;">
                <div class="mb-3">
                    <img src="${o}" alt="TOTP QR Code" style="border-radius: 8px; max-width: 200px; max-height: 200px;">
                </div>
                <small class="text-secondary">Scan with Google Authenticator, Authy, or similar app</small>
                <div class="mt-2">
                    <small class="text-muted">Or copy this URI:</small>
                    <div class="mt-1">
                        <input type="text" class="form-control form-control-sm" value="${l}" readonly onclick="this.select()" style="font-size: 10px;">
                    </div>
                </div>
            </div>
        `}function a(o){const l=document.getElementById("qr-code"),i=document.createElement("div");i.className="mt-3 p-2 rounded",i.style.background="rgba(75, 172, 254, 0.1)",i.style.border="1px solid rgba(75, 172, 254, 0.2)",i.innerHTML=`
            <small class="text-info"><i class="bi bi-info-circle me-1"></i>TOTP Secret:</small><br>
            <span class="text-white">Use your authenticator app for verification codes</span><br>
            <small class="text-secondary">Secret: <code>${o}</code></small>
        `,l.appendChild(i)}const c=document.getElementById("totp-verify-form");c&&c.addEventListener("submit",async o=>{o.preventDefault(),b();const i=new FormData(c).get("totp_code");if(!i||i.length!==6){m("Please enter a valid 6-digit code!","error");return}const p=c.querySelector('button[type="submit"]'),f=p.innerHTML;p.disabled=!0,p.innerHTML='<span class="spinner-border spinner-border-sm me-2" role="status"></span>verifying...';try{t.activateStep("totp-verify"),t.updateSecurityStatus("Verifying 2FA code...");const d=window.currentUsername;if(!d)throw new Error("Username not found");const y=await fetch("http://localhost:3000/totp/verify-setup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:d,token:i})}),u=await y.json();if(console.log("TOTP verification result:",u),!y.ok||!u.success)throw new Error(u.error||"Invalid TOTP code");t.activateStep("success"),t.updateSecurityStatus("Registration complete! Account secured with 2FA."),m("Registration complete! You can now log in with your credentials and 2FA.","success"),setTimeout(()=>{window.location.href="/api/login"},2e3)}catch(d){console.error("TOTP verification error:",d),m(`2FA verification failed: ${d.message||"Invalid code"}`,"error")}finally{p.disabled=!1,p.innerHTML=f}});const n=document.getElementById("totp-code");n&&n.addEventListener("input",()=>{n.value=n.value.replace(/[^0-9]/g,""),n.value.length>6&&(n.value=n.value.slice(0,6))})});
