function T(t){let e=0;for(let r=0;r<t.length;r++)e+=t[r].length;const i=new Uint8Array(new ArrayBuffer(e));for(let r=0,n=0;r<t.length;r++)i.set(t[r],n),n+=t[r].length;return i}function qe(t,e){if(t.length!==e.length||t.length===0)throw new Error("arrays of different length");const i=t.length,r=new Uint8Array(i);for(let n=0;n<i;n++)r[n]=t[n]^e[n];return r}function je(t,e){if(t.length!==e.length||t.length===0)return!1;const i=t.length;let r=0;for(let n=0;n<i;n++)r|=t[n]^e[n];return r===0}function le(t){if(!(t>=0&&t<65535))throw new Error("number bigger than 2^16");return new Uint8Array([t>>8&255,t&255])}function Ge(t){switch(t){case"SHA-1":return{outLenBytes:20,blockLenBytes:64};case"SHA-256":return{outLenBytes:32,blockLenBytes:64};case"SHA-384":return{outLenBytes:48,blockLenBytes:128};case"SHA-512":return{outLenBytes:64,blockLenBytes:128};default:throw new Error(`invalid hash name: ${t}`)}}var a={cipher:{},hash:{},keyexchange:{},mode:{},misc:{},codec:{},exception:{corrupt:function(t){this.toString=function(){return"CORRUPT: "+this.message},this.message=t},invalid:function(t){this.toString=function(){return"INVALID: "+this.message},this.message=t},bug:function(t){this.toString=function(){return"BUG: "+this.message},this.message=t},notReady:function(t){this.toString=function(){return"NOT READY: "+this.message},this.message=t}}};a.cipher.aes=function(t){this._tables[0][0][0]||this._precompute();var e,i,r,n,s,o=this._tables[0][4],c=this._tables[1],h=t.length,l=1;if(h!==4&&h!==6&&h!==8)throw new a.exception.invalid("invalid aes key size");for(this._key=[n=t.slice(0),s=[]],e=h;e<4*h+28;e++)r=n[e-1],(e%h===0||h===8&&e%h===4)&&(r=o[r>>>24]<<24^o[r>>16&255]<<16^o[r>>8&255]<<8^o[r&255],e%h===0&&(r=r<<8^r>>>24^l<<24,l=l<<1^(l>>7)*283)),n[e]=n[e-h]^r;for(i=0;e;i++,e--)r=n[i&3?e:e-4],e<=4||i<4?s[i]=r:s[i]=c[0][o[r>>>24]]^c[1][o[r>>16&255]]^c[2][o[r>>8&255]]^c[3][o[r&255]]};a.cipher.aes.prototype={encrypt:function(t){return this._crypt(t,0)},decrypt:function(t){return this._crypt(t,1)},_tables:[[[],[],[],[],[]],[[],[],[],[],[]]],_precompute:function(){var t=this._tables[0],e=this._tables[1],i=t[4],r=e[4],n,s,o,c=[],h=[],l,f,u,d,y,m;for(n=0;n<256;n++)h[(c[n]=n<<1^(n>>7)*283)^n]=n;for(s=o=0;!i[s];s^=l||1,o=h[o]||1)for(d=o^o<<1^o<<2^o<<3^o<<4,d=d>>8^d&255^99,i[s]=d,r[d]=s,u=c[f=c[l=c[s]]],m=u*16843009^f*65537^l*257^s*16843008,y=c[d]*257^d*16843008,n=0;n<4;n++)t[n][s]=y=y<<24^y>>>8,e[n][d]=m=m<<24^m>>>8;for(n=0;n<5;n++)t[n]=t[n].slice(0),e[n]=e[n].slice(0)},_crypt:function(t,e){if(t.length!==4)throw new a.exception.invalid("invalid aes block size");var i=this._key[e],r=t[0]^i[0],n=t[e?3:1]^i[1],s=t[2]^i[2],o=t[e?1:3]^i[3],c,h,l,f=i.length/4-2,u,d=4,y=[0,0,0,0],m=this._tables[e],p=m[0],b=m[1],w=m[2],E=m[3],F=m[4];for(u=0;u<f;u++)c=p[r>>>24]^b[n>>16&255]^w[s>>8&255]^E[o&255]^i[d],h=p[n>>>24]^b[s>>16&255]^w[o>>8&255]^E[r&255]^i[d+1],l=p[s>>>24]^b[o>>16&255]^w[r>>8&255]^E[n&255]^i[d+2],o=p[o>>>24]^b[r>>16&255]^w[n>>8&255]^E[s&255]^i[d+3],d+=4,r=c,n=h,s=l;for(u=0;u<4;u++)y[e?3&-u:u]=F[r>>>24]<<24^F[n>>16&255]<<16^F[s>>8&255]<<8^F[o&255]^i[d++],c=r,r=n,n=s,s=o,o=c;return y}};a.bitArray={bitSlice:function(t,e,i){return t=a.bitArray._shiftRight(t.slice(e/32),32-(e&31)).slice(1),i===void 0?t:a.bitArray.clamp(t,i-e)},extract:function(t,e,i){var r,n=Math.floor(-e-i&31);return(e+i-1^e)&-32?r=t[e/32|0]<<32-n^t[e/32+1|0]>>>n:r=t[e/32|0]>>>n,r&(1<<i)-1},concat:function(t,e){if(t.length===0||e.length===0)return t.concat(e);var i=t[t.length-1],r=a.bitArray.getPartial(i);return r===32?t.concat(e):a.bitArray._shiftRight(e,r,i|0,t.slice(0,t.length-1))},bitLength:function(t){var e=t.length,i;return e===0?0:(i=t[e-1],(e-1)*32+a.bitArray.getPartial(i))},clamp:function(t,e){if(t.length*32<e)return t;t=t.slice(0,Math.ceil(e/32));var i=t.length;return e=e&31,i>0&&e&&(t[i-1]=a.bitArray.partial(e,t[i-1]&2147483648>>e-1,1)),t},partial:function(t,e,i){return t===32?e:(i?e|0:e<<32-t)+t*1099511627776},getPartial:function(t){return Math.round(t/1099511627776)||32},equal:function(t,e){if(a.bitArray.bitLength(t)!==a.bitArray.bitLength(e))return!1;var i=0,r;for(r=0;r<t.length;r++)i|=t[r]^e[r];return i===0},_shiftRight:function(t,e,i,r){var n,s=0,o;for(r===void 0&&(r=[]);e>=32;e-=32)r.push(i),i=0;if(e===0)return r.concat(t);for(n=0;n<t.length;n++)r.push(i|t[n]>>>e),i=t[n]<<32-e;return s=t.length?t[t.length-1]:0,o=a.bitArray.getPartial(s),r.push(a.bitArray.partial(e+o&31,e+o>32?i:r.pop(),1)),r},_xor4:function(t,e){return[t[0]^e[0],t[1]^e[1],t[2]^e[2],t[3]^e[3]]},byteswapM:function(t){var e,i,r=65280;for(e=0;e<t.length;++e)i=t[e],t[e]=i>>>24|i>>>8&r|(i&r)<<8|i<<24;return t}};a.codec.utf8String={fromBits:function(t){var e="",i=a.bitArray.bitLength(t),r,n;for(r=0;r<i/8;r++)(r&3)===0&&(n=t[r/4]),e+=String.fromCharCode(n>>>8>>>8>>>8),n<<=8;return decodeURIComponent(escape(e))},toBits:function(t){t=unescape(encodeURIComponent(t));var e=[],i,r=0;for(i=0;i<t.length;i++)r=r<<8|t.charCodeAt(i),(i&3)===3&&(e.push(r),r=0);return i&3&&e.push(a.bitArray.partial(8*(i&3),r)),e}};a.codec.hex={fromBits:function(t){var e="",i;for(i=0;i<t.length;i++)e+=((t[i]|0)+0xf00000000000).toString(16).substr(4);return e.substr(0,a.bitArray.bitLength(t)/4)},toBits:function(t){var e,i=[],r;for(t=t.replace(/\s|0x/g,""),r=t.length,t=t+"00000000",e=0;e<t.length;e+=8)i.push(parseInt(t.substr(e,8),16)^0);return a.bitArray.clamp(i,r*4)}};a.codec.base64={_chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",fromBits:function(t,e,i){var r="",n,s=0,o=a.codec.base64._chars,c=0,h=a.bitArray.bitLength(t);for(i&&(o=o.substr(0,62)+"-_"),n=0;r.length*6<h;)r+=o.charAt((c^t[n]>>>s)>>>26),s<6?(c=t[n]<<6-s,s+=26,n++):(c<<=6,s-=6);for(;r.length&3&&!e;)r+="=";return r},toBits:function(t,e){t=t.replace(/\s|=/g,"");var i=[],r,n=0,s=a.codec.base64._chars,o=0,c;for(e&&(s=s.substr(0,62)+"-_"),r=0;r<t.length;r++){if(c=s.indexOf(t.charAt(r)),c<0)throw new a.exception.invalid("this isn't base64!");n>26?(n-=26,i.push(o^c>>>n),o=c<<32-n):(n+=6,o^=c<<32-n)}return n&56&&i.push(a.bitArray.partial(n&56,o,1)),i}};a.codec.base64url={fromBits:function(t){return a.codec.base64.fromBits(t,1,1)},toBits:function(t){return a.codec.base64.toBits(t,1)}};a.codec.bytes={fromBits:function(t){var e=[],i=a.bitArray.bitLength(t),r,n;for(r=0;r<i/8;r++)(r&3)===0&&(n=t[r/4]),e.push(n>>>24),n<<=8;return e},toBits:function(t){var e=[],i,r=0;for(i=0;i<t.length;i++)r=r<<8|t[i],(i&3)===3&&(e.push(r),r=0);return i&3&&e.push(a.bitArray.partial(8*(i&3),r)),e}};a.hash.sha256=function(t){this._key[0]||this._precompute(),t?(this._h=t._h.slice(0),this._buffer=t._buffer.slice(0),this._length=t._length):this.reset()};a.hash.sha256.hash=function(t){return new a.hash.sha256().update(t).finalize()};a.hash.sha256.prototype={blockSize:512,reset:function(){return this._h=this._init.slice(0),this._buffer=[],this._length=0,this},update:function(t){typeof t=="string"&&(t=a.codec.utf8String.toBits(t));var e,i=this._buffer=a.bitArray.concat(this._buffer,t),r=this._length,n=this._length=r+a.bitArray.bitLength(t);if(n>9007199254740991)throw new a.exception.invalid("Cannot hash more than 2^53 - 1 bits");if(typeof Uint32Array<"u"){var s=new Uint32Array(i),o=0;for(e=512+r-(512+r&511);e<=n;e+=512)this._block(s.subarray(16*o,16*(o+1))),o+=1;i.splice(0,16*o)}else for(e=512+r-(512+r&511);e<=n;e+=512)this._block(i.splice(0,16));return this},finalize:function(){var t,e=this._buffer,i=this._h;for(e=a.bitArray.concat(e,[a.bitArray.partial(1,1)]),t=e.length+2;t&15;t++)e.push(0);for(e.push(Math.floor(this._length/4294967296)),e.push(this._length|0);e.length;)this._block(e.splice(0,16));return this.reset(),i},_init:[],_key:[],_precompute:function(){var t=0,e=2,i,r;function n(s){return(s-Math.floor(s))*4294967296|0}for(;t<64;e++){for(r=!0,i=2;i*i<=e;i++)if(e%i===0){r=!1;break}r&&(t<8&&(this._init[t]=n(Math.pow(e,1/2))),this._key[t]=n(Math.pow(e,1/3)),t++)}},_block:function(t){var e,i,r,n,s=this._h,o=this._key,c=s[0],h=s[1],l=s[2],f=s[3],u=s[4],d=s[5],y=s[6],m=s[7];for(e=0;e<64;e++)e<16?i=t[e]:(r=t[e+1&15],n=t[e+14&15],i=t[e&15]=(r>>>7^r>>>18^r>>>3^r<<25^r<<14)+(n>>>17^n>>>19^n>>>10^n<<15^n<<13)+t[e&15]+t[e+9&15]|0),i=i+m+(u>>>6^u>>>11^u>>>25^u<<26^u<<21^u<<7)+(y^u&(d^y))+o[e],m=y,y=d,d=u,u=f+i|0,f=l,l=h,h=c,c=i+(h&l^f&(h^l))+(h>>>2^h>>>13^h>>>22^h<<30^h<<19^h<<10)|0;s[0]=s[0]+c|0,s[1]=s[1]+h|0,s[2]=s[2]+l|0,s[3]=s[3]+f|0,s[4]=s[4]+u|0,s[5]=s[5]+d|0,s[6]=s[6]+y|0,s[7]=s[7]+m|0}};a.mode.ccm={name:"ccm",_progressListeners:[],listenProgress:function(t){a.mode.ccm._progressListeners.push(t)},unListenProgress:function(t){var e=a.mode.ccm._progressListeners.indexOf(t);e>-1&&a.mode.ccm._progressListeners.splice(e,1)},_callProgressListener:function(t){var e=a.mode.ccm._progressListeners.slice(),i;for(i=0;i<e.length;i+=1)e[i](t)},encrypt:function(t,e,i,r,n){var s,o=e.slice(0),c,h=a.bitArray,l=h.bitLength(i)/8,f=h.bitLength(o)/8;if(n=n||64,r=r||[],l<7)throw new a.exception.invalid("ccm: iv must be at least 7 bytes");for(s=2;s<4&&f>>>8*s;s++);return s<15-l&&(s=15-l),i=h.clamp(i,8*(15-s)),c=a.mode.ccm._computeTag(t,e,i,r,n,s),o=a.mode.ccm._ctrMode(t,o,i,c,n,s),h.concat(o.data,o.tag)},decrypt:function(t,e,i,r,n){n=n||64,r=r||[];var s,o=a.bitArray,c=o.bitLength(i)/8,h=o.bitLength(e),l=o.clamp(e,h-n),f=o.bitSlice(e,h-n),u;if(h=(h-n)/8,c<7)throw new a.exception.invalid("ccm: iv must be at least 7 bytes");for(s=2;s<4&&h>>>8*s;s++);if(s<15-c&&(s=15-c),i=o.clamp(i,8*(15-s)),l=a.mode.ccm._ctrMode(t,l,i,f,n,s),u=a.mode.ccm._computeTag(t,l.data,i,r,n,s),!o.equal(l.tag,u))throw new a.exception.corrupt("ccm: tag doesn't match");return l.data},_macAdditionalData:function(t,e,i,r,n,s){var o,c,h,l=[],f=a.bitArray,u=f._xor4;if(o=[f.partial(8,(e.length?64:0)|r-2<<2|s-1)],o=f.concat(o,i),o[3]|=n,o=t.encrypt(o),e.length)for(c=f.bitLength(e)/8,c<=65279?l=[f.partial(16,c)]:c<=4294967295&&(l=f.concat([f.partial(16,65534)],[c])),l=f.concat(l,e),h=0;h<l.length;h+=4)o=t.encrypt(u(o,l.slice(h,h+4).concat([0,0,0])));return o},_computeTag:function(t,e,i,r,n,s){var o,c,h=a.bitArray,l=h._xor4;if(n/=8,n%2||n<4||n>16)throw new a.exception.invalid("ccm: invalid tag length");if(r.length>4294967295||e.length>4294967295)throw new a.exception.bug("ccm: can't deal with 4GiB or more data");for(o=a.mode.ccm._macAdditionalData(t,r,i,n,h.bitLength(e)/8,s),c=0;c<e.length;c+=4)o=t.encrypt(l(o,e.slice(c,c+4).concat([0,0,0])));return h.clamp(o,n*8)},_ctrMode:function(t,e,i,r,n,s){var o,c,h=a.bitArray,l=h._xor4,f,u=e.length,d=h.bitLength(e),y=u/50,m=y;if(f=h.concat([h.partial(8,s-1)],i).concat([0,0,0]).slice(0,4),r=h.bitSlice(l(r,t.encrypt(f)),0,n),!u)return{tag:r,data:[]};for(c=0;c<u;c+=4)c>y&&(a.mode.ccm._callProgressListener(c/u),y+=m),f[3]++,o=t.encrypt(f),e[c]^=o[0],e[c+1]^=o[1],e[c+2]^=o[2],e[c+3]^=o[3];return{tag:r,data:h.clamp(e,d)}}};a.misc.hmac=function(t,e){this._hash=e=e||a.hash.sha256;var i=[[],[]],r,n=e.prototype.blockSize/32;for(this._baseHash=[new e,new e],t.length>n&&(t=e.hash(t)),r=0;r<n;r++)i[0][r]=t[r]^909522486,i[1][r]=t[r]^1549556828;this._baseHash[0].update(i[0]),this._baseHash[1].update(i[1]),this._resultHash=new e(this._baseHash[0])};a.misc.hmac.prototype.encrypt=a.misc.hmac.prototype.mac=function(t){if(this._updated)throw new a.exception.invalid("encrypt on already updated hmac called!");return this.update(t),this.digest(t)};a.misc.hmac.prototype.reset=function(){this._resultHash=new this._hash(this._baseHash[0]),this._updated=!1};a.misc.hmac.prototype.update=function(t){this._updated=!0,this._resultHash.update(t)};a.misc.hmac.prototype.digest=function(){var t=this._resultHash.finalize(),e=new this._hash(this._baseHash[1]).update(t).finalize();return this.reset(),e};a.misc.pbkdf2=function(t,e,i,r,n){if(i=i||1e4,r<0||i<0)throw new a.exception.invalid("invalid params to pbkdf2");typeof t=="string"&&(t=a.codec.utf8String.toBits(t)),typeof e=="string"&&(e=a.codec.utf8String.toBits(e)),n=n||a.misc.hmac;var s=new n(t),o,c,h,l,f,u=[],d=a.bitArray;for(f=1;32*u.length<(r||1);f++){for(o=c=s.encrypt(d.concat(e,[f])),h=1;h<i;h++)for(c=s.encrypt(c),l=0;l<c.length;l++)o[l]^=c[l];u=u.concat(o)}return r&&(u=d.clamp(u,r)),u};a.prng=function(t){this._pools=[new a.hash.sha256],this._poolEntropy=[0],this._reseedCount=0,this._robins={},this._eventId=0,this._collectorIds={},this._collectorIdNext=0,this._strength=0,this._poolStrength=0,this._nextReseed=0,this._key=[0,0,0,0,0,0,0,0],this._counter=[0,0,0,0],this._cipher=void 0,this._defaultParanoia=t,this._collectorsStarted=!1,this._callbacks={progress:{},seeded:{}},this._callbackI=0,this._NOT_READY=0,this._READY=1,this._REQUIRES_RESEED=2,this._MAX_WORDS_PER_BURST=65536,this._PARANOIA_LEVELS=[0,48,64,96,128,192,256,384,512,768,1024],this._MILLISECONDS_PER_RESEED=3e4,this._BITS_PER_RESEED=80};a.prng.prototype={randomWords:function(t,e){var i=[],r,n=this.isReady(e),s;if(n===this._NOT_READY)throw new a.exception.notReady("generator isn't seeded");for(n&this._REQUIRES_RESEED&&this._reseedFromPools(!(n&this._READY)),r=0;r<t;r+=4)(r+1)%this._MAX_WORDS_PER_BURST===0&&this._gate(),s=this._gen4words(),i.push(s[0],s[1],s[2],s[3]);return this._gate(),i.slice(0,t)},setDefaultParanoia:function(t,e){if(t===0&&e!=="Setting paranoia=0 will ruin your security; use it only for testing")throw new a.exception.invalid("Setting paranoia=0 will ruin your security; use it only for testing");this._defaultParanoia=t},addEntropy:function(t,e,i){i=i||"user";var r,n,s,o=new Date().valueOf(),c=this._robins[i],h=this.isReady(),l=0,f;switch(r=this._collectorIds[i],r===void 0&&(r=this._collectorIds[i]=this._collectorIdNext++),c===void 0&&(c=this._robins[i]=0),this._robins[i]=(this._robins[i]+1)%this._pools.length,typeof t){case"number":e===void 0&&(e=1),this._pools[c].update([r,this._eventId++,1,e,o,1,t|0]);break;case"object":if(f=Object.prototype.toString.call(t),f==="[object Uint32Array]"){for(s=[],n=0;n<t.length;n++)s.push(t[n]);t=s}else for(f!=="[object Array]"&&(l=1),n=0;n<t.length&&!l;n++)typeof t[n]!="number"&&(l=1);if(!l){if(e===void 0)for(e=0,n=0;n<t.length;n++)for(s=t[n];s>0;)e++,s=s>>>1;this._pools[c].update([r,this._eventId++,2,e,o,t.length].concat(t))}break;case"string":e===void 0&&(e=t.length),this._pools[c].update([r,this._eventId++,3,e,o,t.length]),this._pools[c].update(t);break;default:l=1}if(l)throw new a.exception.bug("random: addEntropy only supports number, array of numbers or string");this._poolEntropy[c]+=e,this._poolStrength+=e,h===this._NOT_READY&&(this.isReady()!==this._NOT_READY&&this._fireEvent("seeded",Math.max(this._strength,this._poolStrength)),this._fireEvent("progress",this.getProgress()))},isReady:function(t){var e=this._PARANOIA_LEVELS[t!==void 0?t:this._defaultParanoia];return this._strength&&this._strength>=e?this._poolEntropy[0]>this._BITS_PER_RESEED&&new Date().valueOf()>this._nextReseed?this._REQUIRES_RESEED|this._READY:this._READY:this._poolStrength>=e?this._REQUIRES_RESEED|this._NOT_READY:this._NOT_READY},getProgress:function(t){var e=this._PARANOIA_LEVELS[t||this._defaultParanoia];return this._strength>=e||this._poolStrength>e?1:this._poolStrength/e},startCollectors:function(){if(!this._collectorsStarted){if(this._eventListener={loadTimeCollector:this._bind(this._loadTimeCollector),mouseCollector:this._bind(this._mouseCollector),keyboardCollector:this._bind(this._keyboardCollector),accelerometerCollector:this._bind(this._accelerometerCollector),touchCollector:this._bind(this._touchCollector)},window.addEventListener)window.addEventListener("load",this._eventListener.loadTimeCollector,!1),window.addEventListener("mousemove",this._eventListener.mouseCollector,!1),window.addEventListener("keypress",this._eventListener.keyboardCollector,!1),window.addEventListener("devicemotion",this._eventListener.accelerometerCollector,!1),window.addEventListener("touchmove",this._eventListener.touchCollector,!1);else if(document.attachEvent)document.attachEvent("onload",this._eventListener.loadTimeCollector),document.attachEvent("onmousemove",this._eventListener.mouseCollector),document.attachEvent("keypress",this._eventListener.keyboardCollector);else throw new a.exception.bug("can't attach event");this._collectorsStarted=!0}},stopCollectors:function(){this._collectorsStarted&&(window.removeEventListener?(window.removeEventListener("load",this._eventListener.loadTimeCollector,!1),window.removeEventListener("mousemove",this._eventListener.mouseCollector,!1),window.removeEventListener("keypress",this._eventListener.keyboardCollector,!1),window.removeEventListener("devicemotion",this._eventListener.accelerometerCollector,!1),window.removeEventListener("touchmove",this._eventListener.touchCollector,!1)):document.detachEvent&&(document.detachEvent("onload",this._eventListener.loadTimeCollector),document.detachEvent("onmousemove",this._eventListener.mouseCollector),document.detachEvent("keypress",this._eventListener.keyboardCollector)),this._collectorsStarted=!1)},addEventListener:function(t,e){this._callbacks[t][this._callbackI++]=e},removeEventListener:function(t,e){var i,r,n=this._callbacks[t],s=[];for(r in n)n.hasOwnProperty(r)&&n[r]===e&&s.push(r);for(i=0;i<s.length;i++)r=s[i],delete n[r]},_bind:function(t){var e=this;return function(){t.apply(e,arguments)}},_gen4words:function(){for(var t=0;t<4&&(this._counter[t]=this._counter[t]+1|0,!this._counter[t]);t++);return this._cipher.encrypt(this._counter)},_gate:function(){this._key=this._gen4words().concat(this._gen4words()),this._cipher=new a.cipher.aes(this._key)},_reseed:function(t){this._key=a.hash.sha256.hash(this._key.concat(t)),this._cipher=new a.cipher.aes(this._key);for(var e=0;e<4&&(this._counter[e]=this._counter[e]+1|0,!this._counter[e]);e++);},_reseedFromPools:function(t){var e=[],i=0,r;for(this._nextReseed=e[0]=new Date().valueOf()+this._MILLISECONDS_PER_RESEED,r=0;r<16;r++)e.push(Math.random()*4294967296|0);for(r=0;r<this._pools.length&&(e=e.concat(this._pools[r].finalize()),i+=this._poolEntropy[r],this._poolEntropy[r]=0,!(!t&&this._reseedCount&1<<r));r++);this._reseedCount>=1<<this._pools.length&&(this._pools.push(new a.hash.sha256),this._poolEntropy.push(0)),this._poolStrength-=i,i>this._strength&&(this._strength=i),this._reseedCount++,this._reseed(e)},_keyboardCollector:function(){this._addCurrentTimeToEntropy(1)},_mouseCollector:function(t){var e,i;try{e=t.x||t.clientX||t.offsetX||0,i=t.y||t.clientY||t.offsetY||0}catch{e=0,i=0}e!=0&&i!=0&&this.addEntropy([e,i],2,"mouse"),this._addCurrentTimeToEntropy(0)},_touchCollector:function(t){var e=t.touches[0]||t.changedTouches[0],i=e.pageX||e.clientX,r=e.pageY||e.clientY;this.addEntropy([i,r],1,"touch"),this._addCurrentTimeToEntropy(0)},_loadTimeCollector:function(){this._addCurrentTimeToEntropy(2)},_addCurrentTimeToEntropy:function(t){typeof window<"u"&&window.performance&&typeof window.performance.now=="function"?this.addEntropy(window.performance.now(),t,"loadtime"):this.addEntropy(new Date().valueOf(),t,"loadtime")},_accelerometerCollector:function(t){var e=t.accelerationIncludingGravity.x||t.accelerationIncludingGravity.y||t.accelerationIncludingGravity.z;if(window.orientation){var i=window.orientation;typeof i=="number"&&this.addEntropy(i,1,"accelerometer")}e&&this.addEntropy(e,2,"accelerometer"),this._addCurrentTimeToEntropy(0)},_fireEvent:function(t,e){var i,r=a.random._callbacks[t],n=[];for(i in r)r.hasOwnProperty(i)&&n.push(r[i]);for(i=0;i<n.length;i++)n[i](e)}};a.random=new a.prng(6);(function(){function t(){try{return require("crypto")}catch{return null}}try{var e,i,r;if(typeof module<"u"&&module.exports&&(i=t())&&i.randomBytes)e=i.randomBytes(1024/8),e=new Uint32Array(new Uint8Array(e).buffer),a.random.addEntropy(e,1024,"crypto.randomBytes");else if(typeof window<"u"&&typeof Uint32Array<"u"){if(r=new Uint32Array(32),window.crypto&&window.crypto.getRandomValues)window.crypto.getRandomValues(r);else if(window.msCrypto&&window.msCrypto.getRandomValues)window.msCrypto.getRandomValues(r);else return;a.random.addEntropy(r,1024,"crypto.getRandomValues")}}catch(n){typeof window<"u"&&window.console&&(console.log("There was an error collecting entropy from the browser:"),console.log(n))}})();a.json={defaults:{v:1,iter:1e4,ks:128,ts:64,mode:"ccm",adata:"",cipher:"aes"},_encrypt:function(t,e,i,r){i=i||{},r=r||{};var n=a.json,s=n._add({iv:a.random.randomWords(4,0)},n.defaults),o,c,h;if(n._add(s,i),h=s.adata,typeof s.salt=="string"&&(s.salt=a.codec.base64.toBits(s.salt)),typeof s.iv=="string"&&(s.iv=a.codec.base64.toBits(s.iv)),!a.mode[s.mode]||!a.cipher[s.cipher]||typeof t=="string"&&s.iter<=100||s.ts!==64&&s.ts!==96&&s.ts!==128||s.ks!==128&&s.ks!==192&&s.ks!==256||s.iv.length<2||s.iv.length>4)throw new a.exception.invalid("json encrypt: invalid parameters");return typeof t=="string"?(o=a.misc.cachedPbkdf2(t,s),t=o.key.slice(0,s.ks/32),s.salt=o.salt):a.ecc&&t instanceof a.ecc.elGamal.publicKey&&(o=t.kem(),s.kemtag=o.tag,t=o.key.slice(0,s.ks/32)),typeof e=="string"&&(e=a.codec.utf8String.toBits(e)),typeof h=="string"&&(s.adata=h=a.codec.utf8String.toBits(h)),c=new a.cipher[s.cipher](t),n._add(r,s),r.key=t,s.mode==="ccm"&&a.arrayBuffer&&a.arrayBuffer.ccm&&e instanceof ArrayBuffer?s.ct=a.arrayBuffer.ccm.encrypt(c,e,s.iv,h,s.ts):s.ct=a.mode[s.mode].encrypt(c,e,s.iv,h,s.ts),s},encrypt:function(t,e,i,r){var n=a.json,s=n._encrypt.apply(n,arguments);return n.encode(s)},_decrypt:function(t,e,i,r){i=i||{},r=r||{};var n=a.json,s=n._add(n._add(n._add({},n.defaults),e),i,!0),o,c,h,l=s.adata;if(typeof s.salt=="string"&&(s.salt=a.codec.base64.toBits(s.salt)),typeof s.iv=="string"&&(s.iv=a.codec.base64.toBits(s.iv)),!a.mode[s.mode]||!a.cipher[s.cipher]||typeof t=="string"&&s.iter<=100||s.ts!==64&&s.ts!==96&&s.ts!==128||s.ks!==128&&s.ks!==192&&s.ks!==256||!s.iv||s.iv.length<2||s.iv.length>4)throw new a.exception.invalid("json decrypt: invalid parameters");return typeof t=="string"?(c=a.misc.cachedPbkdf2(t,s),t=c.key.slice(0,s.ks/32),s.salt=c.salt):a.ecc&&t instanceof a.ecc.elGamal.secretKey&&(t=t.unkem(a.codec.base64.toBits(s.kemtag)).slice(0,s.ks/32)),typeof l=="string"&&(l=a.codec.utf8String.toBits(l)),h=new a.cipher[s.cipher](t),s.mode==="ccm"&&a.arrayBuffer&&a.arrayBuffer.ccm&&s.ct instanceof ArrayBuffer?o=a.arrayBuffer.ccm.decrypt(h,s.ct,s.iv,s.tag,l,s.ts):o=a.mode[s.mode].decrypt(h,s.ct,s.iv,l,s.ts),n._add(r,s),r.key=t,i.raw===1?o:a.codec.utf8String.fromBits(o)},decrypt:function(t,e,i,r){var n=a.json;return n._decrypt(t,n.decode(e),i,r)},encode:function(t){var e,i="{",r="";for(e in t)if(t.hasOwnProperty(e)){if(!e.match(/^[a-z0-9]+$/i))throw new a.exception.invalid("json encode: invalid property name");switch(i+=r+'"'+e+'":',r=",",typeof t[e]){case"number":case"boolean":i+=t[e];break;case"string":i+='"'+escape(t[e])+'"';break;case"object":i+='"'+a.codec.base64.fromBits(t[e],0)+'"';break;default:throw new a.exception.bug("json encode: unsupported type")}}return i+"}"},decode:function(t){if(t=t.replace(/\s/g,""),!t.match(/^\{.*\}$/))throw new a.exception.invalid("json decode: this isn't json!");var e=t.replace(/^\{|\}$/g,"").split(/,/),i={},r,n;for(r=0;r<e.length;r++){if(!(n=e[r].match(/^\s*(?:(["']?)([a-z][a-z0-9]*)\1)\s*:\s*(?:(-?\d+)|"([a-z0-9+\/%*_.@=\-]*)"|(true|false))$/i)))throw new a.exception.invalid("json decode: this isn't json!");n[3]!=null?i[n[2]]=parseInt(n[3],10):n[4]!=null?i[n[2]]=n[2].match(/^(ct|adata|salt|iv)$/)?a.codec.base64.toBits(n[4]):unescape(n[4]):n[5]!=null&&(i[n[2]]=n[5]==="true")}return i},_add:function(t,e,i){if(t===void 0&&(t={}),e===void 0)return t;var r;for(r in e)if(e.hasOwnProperty(r)){if(i&&t[r]!==void 0&&t[r]!==e[r])throw new a.exception.invalid("required parameter overridden");t[r]=e[r]}return t},_subtract:function(t,e){var i={},r;for(r in t)t.hasOwnProperty(r)&&t[r]!==e[r]&&(i[r]=t[r]);return i},_filter:function(t,e){var i={},r;for(r=0;r<e.length;r++)t[e[r]]!==void 0&&(i[e[r]]=t[e[r]]);return i}};a.encrypt=a.json.encrypt;a.decrypt=a.json.decrypt;a.misc._pbkdf2Cache={};a.misc.cachedPbkdf2=function(t,e){var i=a.misc._pbkdf2Cache,r,n,s,o;return e=e||{},o=e.iter||1e3,n=i[t]=i[t]||{},r=n[o]=n[o]||{firstSalt:e.salt&&e.salt.length?e.salt.slice(0):a.random.randomWords(2,0)},s=e.salt===void 0?r.firstSalt:e.salt,r[s]=r[s]||a.misc.pbkdf2(t,s,e.iter),{key:r[s].slice(0),salt:s.slice(0)}};a.bn=function(t){this.initWith(t)};a.bn.prototype={radix:24,maxMul:8,_class:a.bn,copy:function(){return new this._class(this)},initWith:function(t){var e=0,i;switch(typeof t){case"object":this.limbs=t.limbs.slice(0);break;case"number":this.limbs=[t],this.normalize();break;case"string":for(t=t.replace(/^0x/,""),this.limbs=[],i=this.radix/4,e=0;e<t.length;e+=i)this.limbs.push(parseInt(t.substring(Math.max(t.length-e-i,0),t.length-e),16));break;default:this.limbs=[0]}return this},equals:function(t){typeof t=="number"&&(t=new this._class(t));var e=0,i;for(this.fullReduce(),t.fullReduce(),i=0;i<this.limbs.length||i<t.limbs.length;i++)e|=this.getLimb(i)^t.getLimb(i);return e===0},getLimb:function(t){return t>=this.limbs.length?0:this.limbs[t]},greaterEquals:function(t){typeof t=="number"&&(t=new this._class(t));var e=0,i=0,r,n,s;for(r=Math.max(this.limbs.length,t.limbs.length)-1;r>=0;r--)n=this.getLimb(r),s=t.getLimb(r),i|=s-n&~e,e|=n-s&~i;return(i|~e)>>>31},toString:function(){this.fullReduce();var t="",e,i,r=this.limbs;for(e=0;e<this.limbs.length;e++){for(i=r[e].toString(16);e<this.limbs.length-1&&i.length<6;)i="0"+i;t=i+t}return"0x"+t},addM:function(t){typeof t!="object"&&(t=new this._class(t));var e,i=this.limbs,r=t.limbs;for(e=i.length;e<r.length;e++)i[e]=0;for(e=0;e<r.length;e++)i[e]+=r[e];return this},doubleM:function(){var t,e=0,i,r=this.radix,n=this.radixMask,s=this.limbs;for(t=0;t<s.length;t++)i=s[t],i=i+i+e,s[t]=i&n,e=i>>r;return e&&s.push(e),this},halveM:function(){var t,e=0,i,r=this.radix,n=this.limbs;for(t=n.length-1;t>=0;t--)i=n[t],n[t]=i+e>>1,e=(i&1)<<r;return n[n.length-1]||n.pop(),this},subM:function(t){typeof t!="object"&&(t=new this._class(t));var e,i=this.limbs,r=t.limbs;for(e=i.length;e<r.length;e++)i[e]=0;for(e=0;e<r.length;e++)i[e]-=r[e];return this},mod:function(t){var e=!this.greaterEquals(new a.bn(0));t=new a.bn(t).normalize();var i=new a.bn(this).normalize(),r=0;for(e&&(i=new a.bn(0).subM(i).normalize());i.greaterEquals(t);r++)t.doubleM();for(e&&(i=t.sub(i).normalize());r>0;r--)t.halveM(),i.greaterEquals(t)&&i.subM(t).normalize();return i.trim()},inverseMod:function(t){var e=new a.bn(1),i=new a.bn(0),r=new a.bn(this),n=new a.bn(t),s,o,c=1;if(!(t.limbs[0]&1))throw new a.exception.invalid("inverseMod: p must be odd");do for(r.limbs[0]&1&&(r.greaterEquals(n)||(s=r,r=n,n=s,s=e,e=i,i=s),r.subM(n),r.normalize(),e.greaterEquals(i)||e.addM(t),e.subM(i)),r.halveM(),e.limbs[0]&1&&e.addM(t),e.normalize(),e.halveM(),o=c=0;o<r.limbs.length;o++)c|=r.limbs[o];while(c);if(!n.equals(1))throw new a.exception.invalid("inverseMod: p and x must be relatively prime");return i},add:function(t){return this.copy().addM(t)},sub:function(t){return this.copy().subM(t)},mul:function(t){typeof t=="number"?t=new this._class(t):t.normalize(),this.normalize();var e,i,r=this.limbs,n=t.limbs,s=r.length,o=n.length,c=new this._class,h=c.limbs,l,f=this.maxMul;for(e=0;e<this.limbs.length+t.limbs.length+1;e++)h[e]=0;for(e=0;e<s;e++){for(l=r[e],i=0;i<o;i++)h[e+i]+=l*n[i];--f||(f=this.maxMul,c.cnormalize())}return c.cnormalize().reduce()},square:function(){return this.mul(this)},power:function(t){t=new a.bn(t).normalize().trim().limbs;var e,i,r=new this._class(1),n=this;for(e=0;e<t.length;e++)for(i=0;i<this.radix&&(t[e]&1<<i&&(r=r.mul(n)),!(e==t.length-1&&t[e]>>i+1==0));i++)n=n.square();return r},mulmod:function(t,e){return this.mod(e).mul(t.mod(e)).mod(e)},powermod:function(t,e){if(t=new a.bn(t),e=new a.bn(e),(e.limbs[0]&1)==1){var i=this.montpowermod(t,e);if(i!=!1)return i}var r,n,s=t.normalize().trim().limbs,o=new this._class(1),c=this;for(r=0;r<s.length;r++)for(n=0;n<this.radix&&(s[r]&1<<n&&(o=o.mulmod(c,e)),!(r==s.length-1&&s[r]>>n+1==0));n++)c=c.mulmod(c,e);return o},montpowermod:function(t,e){t=new a.bn(t).normalize().trim(),e=new a.bn(e);var i,r,n=this.radix,s=new this._class(1),o=this.copy(),c,h,l,f=t.bitLength();for(c=new a.bn({limbs:e.copy().normalize().trim().limbs.map(function(){return 0})}),h=this.radix;h>0;h--)if((e.limbs[e.limbs.length-1]>>h&1)==1){c.limbs[c.limbs.length-1]=1<<h;break}if(f==0)return this;f<18?l=1:f<48?l=3:f<144?l=4:f<768?l=5:l=6;for(var u=c.copy(),d=e.copy(),y=new a.bn(1),m=new a.bn(0),p=c.copy();p.greaterEquals(1);)p.halveM(),(y.limbs[0]&1)==0?(y.halveM(),m.halveM()):(y.addM(d),y.halveM(),m.halveM(),m.addM(u));y=y.normalize(),m=m.normalize(),u.doubleM();var b=u.mulmod(u,e);if(!u.mul(y).sub(e.mul(m)).equals(1))return!1;var w=function(v){return E(v,b)},E=function(v,U){var x,C,A,k,H=(1<<h+1)-1;for(C=v.mul(U),A=C.mul(m),A.limbs=A.limbs.slice(0,c.limbs.length),A.limbs.length==c.limbs.length&&(A.limbs[c.limbs.length-1]&=H),A=A.mul(e),k=C.add(A).normalize().trim(),k.limbs=k.limbs.slice(c.limbs.length-1),x=0;x<k.limbs.length;x++)x>0&&(k.limbs[x-1]|=(k.limbs[x]&H)<<n-h-1),k.limbs[x]=k.limbs[x]>>h+1;return k.greaterEquals(e)&&k.subM(e),k},F=function(v){return E(v,1)};o=w(o),s=w(s);var z,S={},N=(1<<l-1)-1;for(S[1]=o.copy(),S[2]=E(o,o),z=1;z<=N;z++)S[2*z+1]=E(S[2*z-1],S[2]);var P=function(v,U){var x=U%v.radix;return(v.limbs[Math.floor(U/v.radix)]&1<<x)>>x};for(i=t.bitLength()-1;i>=0;)if(P(t,i)==0)s=E(s,s),i=i-1;else{for(var L=i-l+1;P(t,L)==0;)L++;var I=0;for(r=L;r<=i;r++)I+=P(t,r)<<r-L,s=E(s,s);s=E(s,S[I]),i=L-1}return F(s)},trim:function(){var t=this.limbs,e;do e=t.pop();while(t.length&&e===0);return t.push(e),this},reduce:function(){return this},fullReduce:function(){return this.normalize()},normalize:function(){var t=0,e,i=this.placeVal,r=this.ipv,n,s,o=this.limbs,c=o.length,h=this.radixMask;for(e=0;e<c||t!==0&&t!==-1;e++)n=(o[e]||0)+t,s=o[e]=n&h,t=(n-s)*r;return t===-1&&(o[e-1]-=i),this.trim(),this},cnormalize:function(){var t=0,e,i=this.ipv,r,n,s=this.limbs,o=s.length,c=this.radixMask;for(e=0;e<o-1;e++)r=s[e]+t,n=s[e]=r&c,t=(r-n)*i;return s[e]+=t,this},toBits:function(t){this.fullReduce(),t=t||this.exponent||this.bitLength();var e=Math.floor((t-1)/24),i=a.bitArray,r=(t+7&-8)%this.radix||this.radix,n=[i.partial(r,this.getLimb(e))];for(e--;e>=0;e--)n=i.concat(n,[i.partial(Math.min(this.radix,t),this.getLimb(e))]),t-=this.radix;return n},bitLength:function(){this.fullReduce();for(var t=this.radix*(this.limbs.length-1),e=this.limbs[this.limbs.length-1];e;e>>>=1)t++;return t+7&-8}};a.bn.fromBits=function(t){var e=this,i=new e,r=[],n=a.bitArray,s=this.prototype,o=Math.min(this.bitLength||4294967296,n.bitLength(t)),c=o%s.radix||s.radix;for(r[0]=n.extract(t,0,c);c<o;c+=s.radix)r.unshift(n.extract(t,c,s.radix));return i.limbs=r,i};a.bn.prototype.ipv=1/(a.bn.prototype.placeVal=Math.pow(2,a.bn.prototype.radix));a.bn.prototype.radixMask=(1<<a.bn.prototype.radix)-1;a.bn.pseudoMersennePrime=function(t,e){function i(c){this.initWith(c)}var r=i.prototype=new a.bn,n,s,o;for(o=r.modOffset=Math.ceil(s=t/r.radix),r.exponent=t,r.offset=[],r.factor=[],r.minOffset=o,r.fullMask=0,r.fullOffset=[],r.fullFactor=[],r.modulus=i.modulus=new a.bn(Math.pow(2,t)),r.fullMask=0|-Math.pow(2,t%r.radix),n=0;n<e.length;n++)r.offset[n]=Math.floor(e[n][0]/r.radix-s),r.fullOffset[n]=Math.floor(e[n][0]/r.radix)-o+1,r.factor[n]=e[n][1]*Math.pow(1/2,t-e[n][0]+r.offset[n]*r.radix),r.fullFactor[n]=e[n][1]*Math.pow(1/2,t-e[n][0]+r.fullOffset[n]*r.radix),r.modulus.addM(new a.bn(Math.pow(2,e[n][0])*e[n][1])),r.minOffset=Math.min(r.minOffset,-r.offset[n]);return r._class=i,r.modulus.cnormalize(),r.reduce=function(){var c,h,l,f=this.modOffset,u=this.limbs,d=this.offset,y=this.offset.length,m=this.factor,p;for(c=this.minOffset;u.length>f;){for(l=u.pop(),p=u.length,h=0;h<y;h++)u[p+d[h]]-=m[h]*l;c--,c||(u.push(0),this.cnormalize(),c=this.minOffset)}return this.cnormalize(),this},r._strongReduce=r.fullMask===-1?r.reduce:function(){var c=this.limbs,h=c.length-1,l,f;if(this.reduce(),h===this.modOffset-1){for(f=c[h]&this.fullMask,c[h]-=f,l=0;l<this.fullOffset.length;l++)c[h+this.fullOffset[l]]-=this.fullFactor[l]*f;this.normalize()}},r.fullReduce=function(){var c,h;for(this._strongReduce(),this.addM(this.modulus),this.addM(this.modulus),this.normalize(),this._strongReduce(),h=this.limbs.length;h<this.modOffset;h++)this.limbs[h]=0;for(c=this.greaterEquals(this.modulus),h=0;h<this.limbs.length;h++)this.limbs[h]-=this.modulus.limbs[h]*c;return this.cnormalize(),this},r.inverse=function(){return this.power(this.modulus.sub(2))},i.fromBits=a.bn.fromBits,i};var G=a.bn.pseudoMersennePrime;a.bn.prime={p127:G(127,[[0,-1]]),p25519:G(255,[[0,-19]]),p192k:G(192,[[32,-1],[12,-1],[8,-1],[7,-1],[6,-1],[3,-1],[0,-1]]),p224k:G(224,[[32,-1],[12,-1],[11,-1],[9,-1],[7,-1],[4,-1],[1,-1],[0,-1]]),p256k:G(256,[[32,-1],[9,-1],[8,-1],[7,-1],[6,-1],[4,-1],[0,-1]]),p192:G(192,[[0,-1],[64,-1]]),p224:G(224,[[0,1],[96,-1]]),p256:G(256,[[0,-1],[96,1],[192,1],[224,-1]]),p384:G(384,[[0,-1],[32,1],[96,-1],[128,-1]]),p521:G(521,[[0,-1]])};a.bn.random=function(t,e){typeof t!="object"&&(t=new a.bn(t));for(var i,r,n=t.limbs.length,s=t.limbs[n-1]+1,o=new a.bn;;){do i=a.random.randomWords(n,e),i[n-1]<0&&(i[n-1]+=4294967296);while(Math.floor(i[n-1]/s)===Math.floor(4294967296/s));for(i[n-1]%=s,r=0;r<n-1;r++)i[r]&=t.radixMask;if(o.limbs=i,!o.greaterEquals(t))return o}};a.ecc={};a.ecc.point=function(t,e,i){e===void 0?this.isIdentity=!0:(e instanceof a.bn&&(e=new t.field(e)),i instanceof a.bn&&(i=new t.field(i)),this.x=e,this.y=i,this.isIdentity=!1),this.curve=t};a.ecc.point.prototype={toJac:function(){return new a.ecc.pointJac(this.curve,this.x,this.y,new this.curve.field(1))},mult:function(t){return this.toJac().mult(t,this).toAffine()},mult2:function(t,e,i){return this.toJac().mult2(t,this,e,i).toAffine()},multiples:function(){var t,e,i;if(this._multiples===void 0)for(i=this.toJac().doubl(),t=this._multiples=[new a.ecc.point(this.curve),this,i.toAffine()],e=3;e<16;e++)i=i.add(this),t.push(i.toAffine());return this._multiples},negate:function(){var t=new this.curve.field(0).sub(this.y).normalize().reduce();return new a.ecc.point(this.curve,this.x,t)},isValid:function(){return this.y.square().equals(this.curve.b.add(this.x.mul(this.curve.a.add(this.x.square()))))},toBits:function(){return a.bitArray.concat(this.x.toBits(),this.y.toBits())}};a.ecc.pointJac=function(t,e,i,r){e===void 0?this.isIdentity=!0:(this.x=e,this.y=i,this.z=r,this.isIdentity=!1),this.curve=t};a.ecc.pointJac.prototype={add:function(t){var e=this,i,r,n,s,o,c,h,l,f,u,d;if(e.curve!==t.curve)throw new a.exception.invalid("sjcl.ecc.add(): Points must be on the same curve to add them!");return e.isIdentity?t.toJac():t.isIdentity?e:(i=e.z.square(),r=t.x.mul(i).subM(e.x),r.equals(0)?e.y.equals(t.y.mul(i.mul(e.z)))?e.doubl():new a.ecc.pointJac(e.curve):(n=t.y.mul(i.mul(e.z)).subM(e.y),s=r.square(),o=n.square(),c=r.square().mul(r).addM(e.x.add(e.x).mul(s)),h=o.subM(c),l=e.x.mul(s).subM(h).mul(n),f=e.y.mul(r.square().mul(r)),u=l.subM(f),d=e.z.mul(r),new a.ecc.pointJac(this.curve,h,u,d)))},doubl:function(){if(this.isIdentity)return this;var t=this.y.square(),e=t.mul(this.x.mul(4)),i=t.square().mul(8),r=this.z.square(),n=this.curve.a.toString()==new a.bn(-3).toString()?this.x.sub(r).mul(3).mul(this.x.add(r)):this.x.square().mul(3).add(r.square().mul(this.curve.a)),s=n.square().subM(e).subM(e),o=e.sub(s).mul(n).subM(i),c=this.y.add(this.y).mul(this.z);return new a.ecc.pointJac(this.curve,s,o,c)},toAffine:function(){if(this.isIdentity||this.z.equals(0))return new a.ecc.point(this.curve);var t=this.z.inverse(),e=t.square();return new a.ecc.point(this.curve,this.x.mul(e).fullReduce(),this.y.mul(e.mul(t)).fullReduce())},mult:function(t,e){typeof t=="number"?t=[t]:t.limbs!==void 0&&(t=t.normalize().limbs);var i,r,n=new a.ecc.point(this.curve).toJac(),s=e.multiples();for(i=t.length-1;i>=0;i--)for(r=a.bn.prototype.radix-4;r>=0;r-=4)n=n.doubl().doubl().doubl().doubl().add(s[t[i]>>r&15]);return n},mult2:function(t,e,i,r){typeof t=="number"?t=[t]:t.limbs!==void 0&&(t=t.normalize().limbs),typeof i=="number"?i=[i]:i.limbs!==void 0&&(i=i.normalize().limbs);var n,s,o=new a.ecc.point(this.curve).toJac(),c=e.multiples(),h=r.multiples(),l,f;for(n=Math.max(t.length,i.length)-1;n>=0;n--)for(l=t[n]|0,f=i[n]|0,s=a.bn.prototype.radix-4;s>=0;s-=4)o=o.doubl().doubl().doubl().doubl().add(c[l>>s&15]).add(h[f>>s&15]);return o},negate:function(){return this.toAffine().negate().toJac()},isValid:function(){var t=this.z.square(),e=t.square(),i=e.mul(t);return this.y.square().equals(this.curve.b.mul(i).add(this.x.mul(this.curve.a.mul(e).add(this.x.square()))))}};a.ecc.curve=function(t,e,i,r,n,s){this.field=t,this.r=new a.bn(e),this.a=new t(i),this.b=new t(r),this.G=new a.ecc.point(this,new t(n),new t(s))};a.ecc.curve.prototype.fromBits=function(t){var e=a.bitArray,i=this.field.prototype.exponent+7&-8,r=new a.ecc.point(this,this.field.fromBits(e.bitSlice(t,0,i)),this.field.fromBits(e.bitSlice(t,i,2*i)));if(!r.isValid())throw new a.exception.corrupt("not on the curve!");return r};a.ecc.curves={c192:new a.ecc.curve(a.bn.prime.p192,"0xffffffffffffffffffffffff99def836146bc9b1b4d22831",-3,"0x64210519e59c80e70fa7e9ab72243049feb8deecc146b9b1","0x188da80eb03090f67cbf20eb43a18800f4ff0afd82ff1012","0x07192b95ffc8da78631011ed6b24cdd573f977a11e794811"),c224:new a.ecc.curve(a.bn.prime.p224,"0xffffffffffffffffffffffffffff16a2e0b8f03e13dd29455c5c2a3d",-3,"0xb4050a850c04b3abf54132565044b0b7d7bfd8ba270b39432355ffb4","0xb70e0cbd6bb4bf7f321390b94a03c1d356c21122343280d6115c1d21","0xbd376388b5f723fb4c22dfe6cd4375a05a07476444d5819985007e34"),c256:new a.ecc.curve(a.bn.prime.p256,"0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551",-3,"0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b","0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296","0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5"),c384:new a.ecc.curve(a.bn.prime.p384,"0xffffffffffffffffffffffffffffffffffffffffffffffffc7634d81f4372ddf581a0db248b0a77aecec196accc52973",-3,"0xb3312fa7e23ee7e4988e056be3f82d19181d9c6efe8141120314088f5013875ac656398d8a2ed19d2a85c8edd3ec2aef","0xaa87ca22be8b05378eb1c71ef320ad746e1d3b628ba79b9859f741e082542a385502f25dbf55296c3a545e3872760ab7","0x3617de4a96262c6f5d9e98bf9292dc29f8f41dbd289a147ce9da3113b5f0b8c00a60b1ce1d7e819d7a431d7c90ea0e5f"),c521:new a.ecc.curve(a.bn.prime.p521,"0x1FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFA51868783BF2F966B7FCC0148F709A5D03BB5C9B8899C47AEBB6FB71E91386409",-3,"0x051953EB9618E1C9A1F929A21A0B68540EEA2DA725B99B315F3B8B489918EF109E156193951EC7E937B1652C0BD3BB1BF073573DF883D2C34F1EF451FD46B503F00","0xC6858E06B70404E9CD9E3ECB662395B4429C648139053FB521F828AF606B4D3DBAA14B5E77EFE75928FE1DC127A2FFA8DE3348B3C1856A429BF97E7E31C2E5BD66","0x11839296A789A3BC0045C8A5FB42C7D1BD998F54449579B446817AFBD17273E662C97EE72995EF42640C550B9013FAD0761353C7086A272C24088BE94769FD16650"),k192:new a.ecc.curve(a.bn.prime.p192k,"0xfffffffffffffffffffffffe26f2fc170f69466a74defd8d",0,3,"0xdb4ff10ec057e9ae26b07d0280b7f4341da5d1b1eae06c7d","0x9b2f2f6d9c5628a7844163d015be86344082aa88d95e2f9d"),k224:new a.ecc.curve(a.bn.prime.p224k,"0x010000000000000000000000000001dce8d2ec6184caf0a971769fb1f7",0,5,"0xa1455b334df099df30fc28a169a467e9e47075a90f7e650eb6b7a45c","0x7e089fed7fba344282cafbd6f7e319f7c0b0bd59e2ca4bdb556d61a5"),k256:new a.ecc.curve(a.bn.prime.p256k,"0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141",0,7,"0x79be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798","0x483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8")};a.ecc.curveName=function(t){var e;for(e in a.ecc.curves)if(a.ecc.curves.hasOwnProperty(e)&&a.ecc.curves[e]===t)return e;throw new a.exception.invalid("no such curve")};a.ecc.deserialize=function(t){var e=["elGamal","ecdsa"];if(!t||!t.curve||!a.ecc.curves[t.curve])throw new a.exception.invalid("invalid serialization");if(e.indexOf(t.type)===-1)throw new a.exception.invalid("invalid type");var i=a.ecc.curves[t.curve];if(t.secretKey){if(!t.exponent)throw new a.exception.invalid("invalid exponent");var r=new a.bn(t.exponent);return new a.ecc[t.type].secretKey(i,r)}else{if(!t.point)throw new a.exception.invalid("invalid point");var n=i.fromBits(a.codec.hex.toBits(t.point));return new a.ecc[t.type].publicKey(i,n)}};a.ecc.basicKey={publicKey:function(t,e){this._curve=t,this._curveBitLength=t.r.bitLength(),e instanceof Array?this._point=t.fromBits(e):this._point=e,this.serialize=function(){var i=a.ecc.curveName(t);return{type:this.getType(),secretKey:!1,point:a.codec.hex.fromBits(this._point.toBits()),curve:i}},this.get=function(){var i=this._point.toBits(),r=a.bitArray.bitLength(i),n=a.bitArray.bitSlice(i,0,r/2),s=a.bitArray.bitSlice(i,r/2);return{x:n,y:s}}},secretKey:function(t,e){this._curve=t,this._curveBitLength=t.r.bitLength(),this._exponent=e,this.serialize=function(){var i=this.get(),r=a.ecc.curveName(t);return{type:this.getType(),secretKey:!0,exponent:a.codec.hex.fromBits(i),curve:r}},this.get=function(){return this._exponent.toBits()}}};a.ecc.basicKey.generateKeys=function(t){return function(i,r,n){if(i=i||256,typeof i=="number"&&(i=a.ecc.curves["c"+i],i===void 0))throw new a.exception.invalid("no such curve");n=n||a.bn.random(i.r,r);var s=i.G.mult(n);return{pub:new a.ecc[t].publicKey(i,s),sec:new a.ecc[t].secretKey(i,n)}}};a.ecc.elGamal={generateKeys:a.ecc.basicKey.generateKeys("elGamal"),publicKey:function(t,e){a.ecc.basicKey.publicKey.apply(this,arguments)},secretKey:function(t,e){a.ecc.basicKey.secretKey.apply(this,arguments)}};a.ecc.elGamal.publicKey.prototype={kem:function(t){var e=a.bn.random(this._curve.r,t),i=this._curve.G.mult(e).toBits(),r=a.hash.sha256.hash(this._point.mult(e).toBits());return{key:r,tag:i}},getType:function(){return"elGamal"}};a.ecc.elGamal.secretKey.prototype={unkem:function(t){return a.hash.sha256.hash(this._curve.fromBits(t).mult(this._exponent).toBits())},dh:function(t){return a.hash.sha256.hash(t._point.mult(this._exponent).toBits())},dhJavaEc:function(t){return t._point.mult(this._exponent).x.toBits()},getType:function(){return"elGamal"}};a.ecc.ecdsa={generateKeys:a.ecc.basicKey.generateKeys("ecdsa")};a.ecc.ecdsa.publicKey=function(t,e){a.ecc.basicKey.publicKey.apply(this,arguments)};a.ecc.ecdsa.publicKey.prototype={verify:function(t,e,i){a.bitArray.bitLength(t)>this._curveBitLength&&(t=a.bitArray.clamp(t,this._curveBitLength));var r=a.bitArray,n=this._curve.r,s=this._curveBitLength,o=a.bn.fromBits(r.bitSlice(e,0,s)),c=a.bn.fromBits(r.bitSlice(e,s,2*s)),h=i?c:c.inverseMod(n),l=a.bn.fromBits(t).mul(h).mod(n),f=o.mul(h).mod(n),u=this._curve.G.mult2(l,f,this._point).x;if(o.equals(0)||c.equals(0)||o.greaterEquals(n)||c.greaterEquals(n)||!u.equals(o)){if(i===void 0)return this.verify(t,e,!0);throw new a.exception.corrupt("signature didn't check out")}return!0},getType:function(){return"ecdsa"}};a.ecc.ecdsa.secretKey=function(t,e){a.ecc.basicKey.secretKey.apply(this,arguments)};a.ecc.ecdsa.secretKey.prototype={sign:function(t,e,i,r){a.bitArray.bitLength(t)>this._curveBitLength&&(t=a.bitArray.clamp(t,this._curveBitLength));var n=this._curve.r,s=n.bitLength(),o=r||a.bn.random(n.sub(1),e).add(1),c=this._curve.G.mult(o).x.mod(n),h=a.bn.fromBits(t).add(c.mul(this._exponent)),l=i?h.inverseMod(n).mul(o).mod(n):h.mul(o.inverseMod(n)).mod(n);return a.bitArray.concat(c.toBits(s),l.toBits(s))},getType:function(){return"ecdsa"}};typeof ArrayBuffer>"u"&&(function(t){t.ArrayBuffer=function(){},t.DataView=function(){}})(void 0);a.codec.arrayBuffer={fromBits:function(t,e,i){var r,n,s,o,c;if(e=e??!0,i=i||8,t.length===0)return new ArrayBuffer(0);if(s=a.bitArray.bitLength(t)/8,a.bitArray.bitLength(t)%8!==0)throw new a.exception.invalid("Invalid bit size, must be divisble by 8 to fit in an arraybuffer correctly");for(e&&s%i!==0&&(s+=i-s%i),o=new DataView(new ArrayBuffer(t.length*4)),n=0;n<t.length;n++)o.setUint32(n*4,t[n]<<32);if(r=new DataView(new ArrayBuffer(s)),r.byteLength===o.byteLength)return o.buffer;for(c=o.byteLength<r.byteLength?o.byteLength:r.byteLength,n=0;n<c;n++)r.setUint8(n,o.getUint8(n));return r.buffer},toBits:function(t){var e,i=[],r,n,s;if(t.byteLength===0)return[];n=new DataView(t),r=n.byteLength-n.byteLength%4;for(var e=0;e<r;e+=4)i.push(n.getUint32(e));if(n.byteLength%4!=0){s=new DataView(new ArrayBuffer(4));for(var e=0,o=n.byteLength%4;e<o;e++)s.setUint8(e+4-o,n.getUint8(r+e));i.push(a.bitArray.partial(n.byteLength%4*8,s.getUint32(0)))}return i},hexDumpBuffer:function(t){for(var e=new DataView(t),i="",r=function(s,o){return s=s+"",s.length>=o?s:new Array(o-s.length+1).join("0")+s},n=0;n<e.byteLength;n+=2)n%16==0&&(i+=`
`+n.toString(16)+"	"),i+=r(e.getUint16(n).toString(16),4)+" ";typeof console===void 0&&(console=console||{log:function(){}}),console.log(i.toUpperCase())}};typeof module<"u"&&module.exports&&(module.exports=a);typeof define=="function"&&define([],function(){return a});class se extends Uint8Array{constructor(){super(...arguments),this._serializedEltBrand=""}}class de extends Uint8Array{constructor(){super(...arguments),this._serializedScalarBrand=""}}async function ze(t,e,i,r){const{outLenBytes:n,blockLenBytes:s}=Ge(t),o=Math.ceil(r/n);if(o>255)throw new Error("too big");let c=i;if(i.length>255){const p=new TextEncoder,b=T([p.encode("H2C-OVERSIZE-DST-"),i]);c=new Uint8Array(await crypto.subtle.digest(t,b))}c=T([c,new Uint8Array([c.length])]);const h=new Uint8Array(s),l=new Uint8Array(2);l[0]=r>>8&255,l[1]=r&255;const f=T([h,e,l,new Uint8Array([0]),c]),u=new Uint8Array(await crypto.subtle.digest(t,f)),d=T([u,new Uint8Array([1]),c]);let y=new Uint8Array(await crypto.subtle.digest(t,d)),m=T([y]);for(let p=2;p<=o;p++){const b=T([qe(y,u),new Uint8Array([p]),c]);y=new Uint8Array(await crypto.subtle.digest(t,b)),m=T([m,y])}return m.slice(0,r)}var O;(function(t){t.P256="P-256",t.P384="P-384",t.P521="P-521"})(O||(O={}));class he{constructor(e){switch(e){case O.P256:this.curve=a.ecc.curves.c256,this.size=32,this.hashParams={hash:"SHA-256",L:48,Z:-10,c2:"0x78bc71a02d89ec07214623f6d0f955072c7cc05604a5a6e23ffbf67115fa5301"};break;case O.P384:this.curve=a.ecc.curves.c384,this.size=48,this.hashParams={hash:"SHA-384",L:72,Z:-12,c2:"0x19877cc1041b7555743c0ae2e3a3e61fb2aaa2e0e87ea557a563d8b598a0940d0a697a9e0b9e92cfaa314f583c9d066"};break;case O.P521:this.curve=a.ecc.curves.c521,this.size=66,this.hashParams={hash:"SHA-512",L:98,Z:-4,c2:"0x8"};break;default:throw new Error(`group not implemented: ${e}`)}this.id=e}static getID(e){switch(e){case"P-256":return O.P256;case"P-384":return O.P384;case"P-521":return O.P521;default:throw new Error(`group not implemented: ${e}`)}}identity(){return new a.ecc.point(this.curve)}generator(){return this.curve.G}order(){return this.curve.r}serUnComp(e){const i=a.codec.arrayBuffer.fromBits(e.toBits(),!1),r=new Uint8Array(i);if(r.length!==2*this.size)throw new Error("error serializing element");const n=new se(1+2*this.size);return n[0]=4,n.set(r,1),n}serComp(e){const i=a.codec.arrayBuffer.fromBits(e.x.toBits(),!1),r=new Uint8Array(i),n=new se(1+this.size);return n[0]=2|e.y.limbs[0]&1,n.set(r,1+this.size-r.length),n}serialize(e,i=!0){return e.isIdentity?new se(1):(e.x.fullReduce(),e.y.fullReduce(),i?this.serComp(e):this.serUnComp(e))}deserComp(e){const i=Array.from(e.slice(1)),r=a.codec.bytes.toBits(i),n=new this.curve.field(a.bn.fromBits(r)),s=this.curve.field.modulus,o=s.add(new a.bn(1)).halveM().halveM();let c=n.square().add(this.curve.a).mul(n).add(this.curve.b).power(o);c.fullReduce(),(e[0]&1)!==(c.limbs[0]&1)&&(c=s.sub(c).mod(s));const h=new a.ecc.point(this.curve,new a.bn(n),new a.bn(c));if(!h.isValid())throw new Error("point not in curve");return h}deserUnComp(e){const i=Array.from(e.slice(1)),r=a.codec.bytes.toBits(i),n=this.curve.fromBits(r);return n.x.fullReduce(),n.y.fullReduce(),n}deserialize(e){const i=e.length;switch(!0){case(i===1&&e[0]===0):return this.identity();case(i===1+this.size&&(e[0]===2||e[0]===3)):return this.deserComp(e);case(i===1+2*this.size&&e[0]===4):return this.deserUnComp(e);default:throw new Error("error deserializing element")}}serializeScalar(e){const i=e.mod(this.curve.r);i.normalize();const r=a.codec.arrayBuffer.fromBits(i.toBits(),!1),n=new Uint8Array(r),s=new de(this.size);return s.set(n,this.size-n.length),s}deserializeScalar(e){const i=Array.from(e),r=a.bn.fromBits(a.codec.bytes.toBits(i));if(r.normalize(),r.greaterEquals(this.curve.r))throw new Error("error deserializing scalar");return r}addScalar(e,i){const r=e.add(i);return r.mod(this.curve.r),r.normalize(),r}invScalar(e){return e.inverseMod(this.curve.r)}static mul(e,i){return i.mult(e)}mulBase(e){return this.curve.G.mult(e)}equal(e,i){return this.curve!==e.curve||this.curve!==i.curve?!1:e.isIdentity&&i.isIdentity?!0:e.x.equals(i.x)&&e.y.equals(i.y)}randomScalar(){const e=new Uint8Array(this.hashParams.L);return crypto.getRandomValues(e),this.hashToScalar(e,new Uint8Array)}async hashToScalar(e,i){const{hash:r,L:n}=this.hashParams,s=await ze(r,e,i,n),o=Array.from(s),c=a.codec.bytes.toBits(o);return a.bn.fromBits(c).mod(this.curve.r)}async hashToGroup(e,i){const r=await this.hashToField(e,i,2),n=this.sswu(r[0]),s=this.sswu(r[1]);return n.toJac().add(s).toAffine()}async hashToField(e,i,r){const{hash:n,L:s}=this.hashParams,o=await ze(n,e,i,r*s),c=new Array(r);for(let h=0;h<r;h++){const l=h*s,f=Array.from(o.slice(l,l+s)),u=a.codec.bytes.toBits(f);c[h]=new this.curve.field(a.bn.fromBits(u))}return c}sswu(e){const i=this.curve.a,r=this.curve.b,n=this.curve.field.modulus,s=new this.curve.field(this.hashParams.Z),o=new a.bn(this.hashParams.c2),c=n.sub(new a.bn(3)).halveM().halveM(),h=new this.curve.field(0),l=new this.curve.field(1);function f(A){return A.fullReduce(),A.limbs[0]&1}function u(A,k,H){return H?k:A}let d=e.square();const y=s.mul(d);let m=y.square(),p=m.add(y),b=p.add(l);b=b.mul(r);let w=n.sub(i);p=p.mul(w);const E=p.equals(h);w=i.mul(s),p=u(p,w,E),m=p.square();const F=m.mul(p);m=m.mul(i);let z=b.square();z=z.add(m),z=z.mul(b),m=F.mul(r),z=z.add(m),w=F.square(),m=z.mul(F),w=w.mul(m);let S=w.power(c);S=S.mul(m);const N=y.mul(b);let P=S.mul(o);P=P.mul(d),P=P.mul(e),m=S.square(),m=m.mul(F);const L=m.equals(z),I=u(N,b,L);let v=u(P,S,L);const U=f(e)===f(v);d=n.sub(v),v=u(d,v,U);let x=p.inverseMod(n);x=I.mul(x);const C=new a.ecc.point(this.curve,new a.bn(x),new a.bn(v));if(!C.isValid())throw new Error("point not in curve");return C}}he.paranoia=6;class Ue extends de{constructor(){super(...arguments),this._BlindBrand=""}}class xe extends se{constructor(){super(...arguments),this._BlindedBrand=""}}class _e extends se{constructor(){super(...arguments),this._EvaluationBrand=""}}var K;(function(t){t[t.OPRF_P256_SHA256=3]="OPRF_P256_SHA256",t[t.OPRF_P384_SHA384=4]="OPRF_P384_SHA384",t[t.OPRF_P521_SHA512=5]="OPRF_P521_SHA512"})(K||(K={}));class _{constructor(e){this.params=_.params(e)}static validateID(e){switch(e){case K.OPRF_P256_SHA256:case K.OPRF_P384_SHA384:case K.OPRF_P521_SHA512:return!0;default:throw new Error(`not supported ID: ${e}`)}}static params(e){_.validateID(e);let i=O.P256,r="SHA-256";switch(e){case K.OPRF_P256_SHA256:break;case K.OPRF_P384_SHA384:i=O.P384,r="SHA-384";break;case K.OPRF_P521_SHA512:i=O.P521,r="SHA-512";break;default:throw new Error(`not supported ID: ${e}`)}const n=new he(i);return{id:e,gg:n,hash:r,blindedSize:1+n.size,evaluationSize:1+n.size,blindSize:n.size}}static getContextString(e){return _.validateID(e),T([new TextEncoder().encode(_.version),new Uint8Array([_.mode,0,e])])}static getHashToGroupDST(e){return T([new TextEncoder().encode("HashToGroup-"),_.getContextString(e)])}static getHashToScalarDST(e){return T([new TextEncoder().encode("HashToScalar-"),_.getContextString(e)])}static getEvalContext(e,i){return T([new TextEncoder().encode("Context-"),_.getContextString(e),le(i.length),i])}async coreFinalize(e,i,r){const n=T([new TextEncoder().encode("Finalize-"),_.getContextString(this.params.id)]),s=T([le(e.length),e,le(i.length),i,le(r.length),r,le(n.length),n]);return new Uint8Array(await crypto.subtle.digest(this.params.hash,s))}}_.mode=0;_.version="VOPRF08-";class Be extends _{async randomBlinder(){const e=await this.params.gg.randomScalar(),i=new Ue(this.params.gg.serializeScalar(e));return{scalar:e,blind:i}}async blind(e){const{scalar:i,blind:r}=await this.randomBlinder(),n=_.getHashToGroupDST(this.params.id),s=await this.params.gg.hashToGroup(e,n),o=he.mul(i,s),c=new xe(this.params.gg.serialize(o));return{blind:r,blindedElement:c}}finalize(e,i,r,n){const s=this.params.gg.deserializeScalar(r),o=this.params.gg.invScalar(s),c=this.params.gg.deserialize(n),h=he.mul(o,c),l=this.params.gg.serialize(h);return this.coreFinalize(e,i,l)}}class Ve extends _{constructor(e,i){super(e),this.supportsWebCryptoOPRF=!1,this.privateKey=i}async evaluate(e,i){const r=_.getEvalContext(this.params.id,i),n=_.getHashToScalarDST(this.params.id),s=await this.params.gg.hashToScalar(r,n),o=new de(this.privateKey),c=this.params.gg.deserializeScalar(o),h=this.params.gg.addScalar(c,s),l=this.params.gg.invScalar(h);if(this.supportsWebCryptoOPRF){const f=this.params.gg.serializeScalar(l);return this.evaluateWebCrypto(e,f)}return Promise.resolve(this.evaluateSJCL(e,l))}async evaluateWebCrypto(e,i){const r=await crypto.subtle.importKey("raw",i,{name:"OPRF",namedCurve:this.params.gg.id},!0,["sign"]);let n=Uint8Array.from(e);if(e[0]===4){const o=this.params.gg.deserialize(e);n=Uint8Array.from(this.params.gg.serialize(o,!0))}const s=await crypto.subtle.sign("OPRF",r,n);return new _e(s)}evaluateSJCL(e,i){const r=this.params.gg.deserialize(e),n=he.mul(i,r);return new _e(this.params.gg.serialize(n))}async fullEvaluate(e,i){const r=_.getHashToGroupDST(this.params.id),n=await this.params.gg.hashToGroup(e,r),s=new xe(this.params.gg.serialize(n)),o=await this.evaluate(s,i);return await this.coreFinalize(e,i,o)}async verifyFinalize(e,i,r){const n=await this.fullEvaluate(e,r);return je(i,n)}}function Qe(t){const{gg:e}=_.params(t);return{Nsk:e.size,Npk:1+e.size}}async function $e(t){const{gg:e}=_.params(t),i=await e.randomScalar();return new Uint8Array(e.serializeScalar(i))}function Fe(t,e){const{gg:i}=_.params(t),r=i.deserializeScalar(new de(e)),n=i.mulBase(r);return new Uint8Array(i.serialize(n))}function B(t){let e=0;for(let r=0;r<t.length;r++)e+=t[r].length;const i=new Uint8Array(new ArrayBuffer(e));for(let r=0,n=0;r<t.length;r++)i.set(t[r],n),n+=t[r].length;return i}function Ce(t,e){if(!(e>0&&e<=32))throw new Error("only supports 32-bit encoding");const i=1<<e;if(!(t>=0&&t<i))throw new Error(`number out of range [0,2^${e}-1]`);const r=Math.ceil(e/8),n=new Uint8Array(r);for(let s=0;s<r;s++)n[r-1-s]=t>>8*s&255;return n}function Re(t,e){return B([Ce(t.length,e),t])}function Pe(t){return Re(t,8)}function ue(t){return Re(t,16)}function j(t,e,i="array"){if(t.length<e)throw new Error(`${i} has wrong length`);return t.slice(0,e)}function We(t,e){if(t.length!==e.length||t.length===0)throw new Error("arrays of different length");const i=t.length,r=new Uint8Array(i);for(let n=0;n<i;n++)r[n]=t[n]^e[n];return r}function Je(t,e){if(t.length!==e.length||t.length===0)throw new Error("arrays of different length");const i=t.length;let r=0;for(let n=0;n<i;n++)r|=t[n]^e[n];return r===0}const Ye=new TextEncoder;function R(t){return Array.from(Ye.encode(t))}const M={AuthKey:R("AuthKey"),ClientMAC:R("ClientMAC"),CredentialResponsePad:R("CredentialResponsePad"),ExportKey:R("ExportKey"),HandshakeSecret:R("HandshakeSecret"),MaskingKey:R("MaskingKey"),OPAQUE:R("OPAQUE-"),OPAQUE_DeriveAuthKeyPair:R("OPAQUE-DeriveAuthKeyPair"),OPAQUE_DeriveKeyPair:R("OPAQUE-DeriveKeyPair"),OprfKey:R("OprfKey"),PrivateKey:R("PrivateKey"),RFC:R("RFCXXXX"),ServerMAC:R("ServerMAC"),SessionKey:R("SessionKey")};class Xe{constructor(e){this.id=e;const{blindedSize:i,hash:r}=_.params(e);this.Noe=i,this.hash=r,this.name=K[e]}async blind(e){const i=await new Be(this.id).blind(e);return{blind:new Uint8Array(i.blind.buffer),blindedElement:new Uint8Array(i.blindedElement.buffer)}}async evaluate(e,i){const r=await new Ve(this.id,e).evaluate(new xe(i),new Uint8Array);return new Uint8Array(r.buffer)}finalize(e,i,r){return new Be(this.id).finalize(e,new Uint8Array,new Ue(i),new _e(r))}async deriveOPRFKey(e){const{gg:i}=_.params(this.id),r=await i.hashToScalar(e,Uint8Array.from(M.OPAQUE_DeriveKeyPair));return new Uint8Array(i.serializeScalar(r))}}function Ze(t,e,i,r,n){const s=B([Ce(n,16),Pe(B([Uint8Array.from(M.OPAQUE),i])),Pe(r)]);return t.kdf.expand(e,s,n)}function me(t,e,i,r){return Ze(t,e,i,r,t.kdf.Nx)}function et(t,e,i,r,n){return B([Uint8Array.from(M.RFC),ue(n),ue(r),Uint8Array.from(t.serialize()),ue(i),Uint8Array.from(e.response.serialize()),e.auth_response.server_nonce,e.auth_response.server_keyshare])}function tt(t,e){const{gg:i}=_.params(t.oprf.id),r=new Array(3);for(let n=0;n<3;n++){const{sk:s,pk:o}=e[n],c=i.deserialize(new se(o)),h=i.deserializeScalar(new de(s)),l=he.mul(h,c);r[n]=i.serialize(l)}return B(r)}async function it(t,e,i){const r=new Uint8Array(t.hash.Nh),n=await t.kdf.extract(r,e),s=await t.hash.sum(i),o=await me(t,n,Uint8Array.from(M.HandshakeSecret),s),c=await me(t,n,Uint8Array.from(M.SessionKey),s),h=new Uint8Array,l=await me(t,o,Uint8Array.from(M.ServerMAC),h),f=await me(t,o,Uint8Array.from(M.ClientMAC),h);return{Km2:l,Km3:f,session_key:c}}class rt{constructor(e){this.oprfID=e;const{Npk:i,Nsk:r}=Qe(e);this.Npk=i,this.Nsk=r}async deriveAuthKeyPair(e){const{gg:i}=_.params(this.oprfID),r=await i.hashToScalar(e,Uint8Array.from(M.OPAQUE_DeriveAuthKeyPair)),n=new Uint8Array(i.serializeScalar(r)),s=Fe(this.oprfID,n);return{private_key:n,public_key:s}}recoverPublicKey(e){const i=Fe(this.oprfID,e);return{private_key:e,public_key:i}}async generateAuthKeyPair(){const e=this.recoverPublicKey(await $e(this.oprfID));return{private_key:Array.from(e.private_key),public_key:Array.from(e.public_key)}}}/*! noble-hashes - MIT License (c) 2021 Paul Miller (paulmillr.com) */const we=t=>new Uint32Array(t.buffer,t.byteOffset,Math.floor(t.byteLength/4)),ye=t=>new DataView(t.buffer,t.byteOffset,t.byteLength),V=(t,e)=>t<<32-e|t>>>e,nt=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!nt)throw new Error("Non little-endian hardware is not supported");Array.from({length:256},(t,e)=>e.toString(16).padStart(2,"0"));(()=>{const t=typeof module<"u"&&typeof module.require=="function"&&module.require.bind(module);try{if(t){const{setImmediate:e}=t("timers");return()=>new Promise(i=>e(i))}}catch{}return()=>new Promise(e=>setTimeout(e,0))})();function fe(t){if(typeof t=="string"&&(t=new TextEncoder().encode(t)),!(t instanceof Uint8Array))throw new TypeError(`Expected input type is Uint8Array (got ${typeof t})`);return t}function q(t){if(!Number.isSafeInteger(t))throw new Error(`Wrong integer: ${t}`)}function Me(t){if(typeof t!="function"||typeof t.init!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");q(t.outputLen),q(t.blockLen)}let ve=class{clone(){return this._cloneInto()}};const st=t=>Object.prototype.toString.call(t)==="[object Object]"&&t.constructor===Object;function Te(t,e){if(e!==void 0&&(typeof e!="object"||!st(e)))throw new TypeError("Options should be object or undefined");return Object.assign(t,e)}function at(t){const e=r=>t().update(fe(r)).digest(),i=t();return e.outputLen=i.outputLen,e.blockLen=i.blockLen,e.create=()=>t(),e.init=e.create,e}function ot(t,e,i,r){if(typeof t.setBigUint64=="function")return t.setBigUint64(e,i,r);const n=BigInt(32),s=BigInt(4294967295),o=Number(i>>n&s),c=Number(i&s),h=r?4:0,l=r?0:4;t.setUint32(e+h,o,r),t.setUint32(e+l,c,r)}class ct extends ve{constructor(e,i,r,n){super(),this.blockLen=e,this.outputLen=i,this.padOffset=r,this.isLE=n,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=ye(this.buffer)}update(e){if(this.destroyed)throw new Error("instance is destroyed");const{view:i,buffer:r,blockLen:n,finished:s}=this;if(s)throw new Error("digest() was already called");e=fe(e);const o=e.length;for(let c=0;c<o;){const h=Math.min(n-this.pos,o-c);if(h===n){const l=ye(e);for(;n<=o-c;c+=n)this.process(l,c);continue}r.set(e.subarray(c,c+h),this.pos),this.pos+=h,c+=h,this.pos===n&&(this.process(i,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){if(this.destroyed)throw new Error("instance is destroyed");if(!(e instanceof Uint8Array)||e.length<this.outputLen)throw new Error("_Sha2: Invalid output buffer");if(this.finished)throw new Error("digest() was already called");this.finished=!0;const{buffer:i,view:r,blockLen:n,isLE:s}=this;let{pos:o}=this;i[o++]=128,this.buffer.subarray(o).fill(0),this.padOffset>n-o&&(this.process(r,0),o=0);for(let h=o;h<n;h++)i[h]=0;ot(r,n-8,BigInt(this.length*8),s),this.process(r,0);const c=ye(e);this.get().forEach((h,l)=>c.setUint32(4*l,h,s))}digest(){const{buffer:e,outputLen:i}=this;this.digestInto(e);const r=e.slice(0,i);return this.destroy(),r}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:i,buffer:r,length:n,finished:s,destroyed:o,pos:c}=this;return e.length=n,e.pos=c,e.finished=s,e.destroyed=o,n%i&&e.buffer.set(r),e}}const ht=(t,e,i)=>t&e^~t&i,lt=(t,e,i)=>t&e^t&i^e&i,ut=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),J=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Y=new Uint32Array(64);class ft extends ct{constructor(){super(64,32,8,!1),this.A=J[0]|0,this.B=J[1]|0,this.C=J[2]|0,this.D=J[3]|0,this.E=J[4]|0,this.F=J[5]|0,this.G=J[6]|0,this.H=J[7]|0}get(){const{A:e,B:i,C:r,D:n,E:s,F:o,G:c,H:h}=this;return[e,i,r,n,s,o,c,h]}set(e,i,r,n,s,o,c,h){this.A=e|0,this.B=i|0,this.C=r|0,this.D=n|0,this.E=s|0,this.F=o|0,this.G=c|0,this.H=h|0}process(e,i){for(let u=0;u<16;u++,i+=4)Y[u]=e.getUint32(i,!1);for(let u=16;u<64;u++){const d=Y[u-15],y=Y[u-2],m=V(d,7)^V(d,18)^d>>>3,p=V(y,17)^V(y,19)^y>>>10;Y[u]=p+Y[u-7]+m+Y[u-16]|0}let{A:r,B:n,C:s,D:o,E:c,F:h,G:l,H:f}=this;for(let u=0;u<64;u++){const d=V(c,6)^V(c,11)^V(c,25),y=f+d+ht(c,h,l)+ut[u]+Y[u]|0,p=(V(r,2)^V(r,13)^V(r,22))+lt(r,n,s)|0;f=l,l=h,h=c,c=o+y|0,o=s,s=n,n=r,r=y+p|0}r=r+this.A|0,n=n+this.B|0,s=s+this.C|0,o=o+this.D|0,c=c+this.E|0,h=h+this.F|0,l=l+this.G|0,f=f+this.H|0,this.set(r,n,s,o,c,h,l,f)}roundClean(){Y.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}const De=at(()=>new ft);class Ie extends ve{constructor(e,i){super(),this.finished=!1,this.destroyed=!1,Me(e);const r=fe(i);if(this.iHash=e.create(),!(this.iHash instanceof ve))throw new TypeError("Expected instance of class which extends utils.Hash");const n=this.blockLen=this.iHash.blockLen;this.outputLen=this.iHash.outputLen;const s=new Uint8Array(n);s.set(r.length>this.iHash.blockLen?e.create().update(r).digest():r);for(let o=0;o<s.length;o++)s[o]^=54;this.iHash.update(s),this.oHash=e.create();for(let o=0;o<s.length;o++)s[o]^=106;this.oHash.update(s),s.fill(0)}update(e){if(this.destroyed)throw new Error("instance is destroyed");return this.iHash.update(e),this}digestInto(e){if(this.destroyed)throw new Error("instance is destroyed");if(!(e instanceof Uint8Array)||e.length!==this.outputLen)throw new Error("HMAC: Invalid output buffer");if(this.finished)throw new Error("digest() was already called");this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:i,iHash:r,finished:n,destroyed:s,blockLen:o,outputLen:c}=this;return e=e,e.finished=n,e.destroyed=s,e.blockLen=o,e.outputLen=c,e.oHash=i._cloneInto(e.oHash),e.iHash=r._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const pe=(t,e,i)=>new Ie(t,e).update(i).digest();pe.create=(t,e)=>new Ie(t,e);pe.init=pe.create;function dt(t,e,i,r){Me(t);const n=Te({dkLen:32,asyncTick:10},r),{c:s,dkLen:o,asyncTick:c}=n;if(q(s),q(o),q(c),s<1)throw new Error("PBKDF2: iterations (c) should be >= 1");const h=fe(e),l=fe(i),f=new Uint8Array(o),u=pe.init(t,h),d=u._cloneInto().update(l);return{c:s,dkLen:o,asyncTick:c,DK:f,PRF:u,PRFSalt:d}}function mt(t,e,i,r,n){return t.destroy(),e.destroy(),r&&r.destroy(),n.fill(0),i}function He(t,e,i,r){const{c:n,dkLen:s,DK:o,PRF:c,PRFSalt:h}=dt(t,e,i,r);let l;const f=new Uint8Array(4),u=ye(f),d=new Uint8Array(c.outputLen);for(let y=1,m=0;m<s;y++,m+=c.outputLen){const p=o.subarray(m,m+c.outputLen);u.setInt32(0,y,!1),(l=h._cloneInto(l)).update(f).digestInto(d),p.set(d.subarray(0,p.length));for(let b=1;b<n;b++){c._cloneInto(l).update(d).digestInto(d);for(let w=0;w<p.length;w++)p[w]^=d[w]}}return mt(c,h,o,l,d)}const g=(t,e)=>t<<e|t>>>32-e;function Le(t,e,i,r,n,s){let o=t[e++]^i[r++],c=t[e++]^i[r++],h=t[e++]^i[r++],l=t[e++]^i[r++],f=t[e++]^i[r++],u=t[e++]^i[r++],d=t[e++]^i[r++],y=t[e++]^i[r++],m=t[e++]^i[r++],p=t[e++]^i[r++],b=t[e++]^i[r++],w=t[e++]^i[r++],E=t[e++]^i[r++],F=t[e++]^i[r++],z=t[e++]^i[r++],S=t[e++]^i[r++],N=o,P=c,L=h,I=l,v=f,U=u,x=d,C=y,A=m,k=p,H=b,X=w,Z=E,ee=F,te=z,ie=S;for(let Se=0;Se<8;Se+=2)v^=g(N+Z|0,7),A^=g(v+N|0,9),Z^=g(A+v|0,13),N^=g(Z+A|0,18),k^=g(U+P|0,7),ee^=g(k+U|0,9),P^=g(ee+k|0,13),U^=g(P+ee|0,18),te^=g(H+x|0,7),L^=g(te+H|0,9),x^=g(L+te|0,13),H^=g(x+L|0,18),I^=g(ie+X|0,7),C^=g(I+ie|0,9),X^=g(C+I|0,13),ie^=g(X+C|0,18),P^=g(N+I|0,7),L^=g(P+N|0,9),I^=g(L+P|0,13),N^=g(I+L|0,18),x^=g(U+v|0,7),C^=g(x+U|0,9),v^=g(C+x|0,13),U^=g(v+C|0,18),X^=g(H+k|0,7),A^=g(X+H|0,9),k^=g(A+X|0,13),H^=g(k+A|0,18),Z^=g(ie+te|0,7),ee^=g(Z+ie|0,9),te^=g(ee+Z|0,13),ie^=g(te+ee|0,18);n[s++]=o+N|0,n[s++]=c+P|0,n[s++]=h+L|0,n[s++]=l+I|0,n[s++]=f+v|0,n[s++]=u+U|0,n[s++]=d+x|0,n[s++]=y+C|0,n[s++]=m+A|0,n[s++]=p+k|0,n[s++]=b+H|0,n[s++]=w+X|0,n[s++]=E+Z|0,n[s++]=F+ee|0,n[s++]=z+te|0,n[s++]=S+ie|0}function ge(t,e,i,r,n){let s=r+0,o=r+16*n;for(let c=0;c<16;c++)i[o+c]=t[e+(2*n-1)*16+c];for(let c=0;c<n;c++,s+=16,e+=16)Le(i,o,t,e,i,s),c>0&&(o+=16),Le(i,s,t,e+=16,i,o)}function yt(t,e,i){const r=Te({dkLen:32,asyncTick:10,maxmem:1073742848},i),{N:n,r:s,p:o,dkLen:c,asyncTick:h,maxmem:l,onProgress:f}=r;if(q(n),q(s),q(o),q(c),q(h),q(l),f!==void 0&&typeof f!="function")throw new Error("progressCb should be function");const u=128*s,d=u/4;if(n<=1||(n&n-1)!==0||n>=2**(u/8)||n>2**32)throw new Error("Scrypt: N must be larger than 1, a power of 2, less than 2^(128 * r / 8) and less than 2^32");if(o<0||o>(2**32-1)*32/u)throw new Error("Scrypt: p must be a positive integer less than or equal to ((2^32 - 1) * 32) / (128 * r)");if(c<0||c>(2**32-1)*32)throw new Error("Scrypt: dkLen should be positive integer less than or equal to (2^32 - 1) * 32");const y=u*(n+o);if(y>l)throw new Error(`Scrypt: parameters too large, ${y} (128 * r * (N + p)) > ${l} (maxmem)`);const m=He(De,t,e,{c:1,dkLen:u*o}),p=we(m),b=we(new Uint8Array(u*n)),w=we(new Uint8Array(u));let E=()=>{};if(f){const F=2*n*o,z=Math.max(Math.floor(F/1e4),1);let S=0;E=()=>{S++,f&&(!(S%z)||S===F)&&f(S/F)}}return{N:n,r:s,p:o,dkLen:c,blockSize32:d,V:b,B32:p,B:m,tmp:w,blockMixCb:E,asyncTick:h}}function pt(t,e,i,r,n){const s=He(De,t,i,{c:1,dkLen:e});return i.fill(0),r.fill(0),n.fill(0),s}function bt(t,e,i){const{N:r,r:n,p:s,dkLen:o,blockSize32:c,V:h,B32:l,B:f,tmp:u,blockMixCb:d}=yt(t,e,i);for(let y=0;y<s;y++){const m=c*y;for(let p=0;p<c;p++)h[p]=l[m+p];for(let p=0,b=0;p<r-1;p++)ge(h,b,h,b+=c,n),d();ge(h,(r-1)*c,l,m,n),d();for(let p=0;p<r;p++){const b=l[m+c-16]%r;for(let w=0;w<c;w++)u[w]=l[m+w]^h[b*c+w];ge(u,0,l,m,n),d()}}return pt(t,o,f,h,u)}class wt{random(e){return Array.from(crypto.getRandomValues(new Uint8Array(e)))}}class W{constructor(e){switch(this.name=e,e){case W.ID.SHA1:this.Nh=20;break;case W.ID.SHA256:this.Nh=32;break;case W.ID.SHA384:this.Nh=48;break;case W.ID.SHA512:this.Nh=64;break;default:throw new Error(`invalid hash name: ${e}`)}}async sum(e){return new Uint8Array(await crypto.subtle.digest(this.name,e))}}(function(t){t.ID={SHA1:"SHA-1",SHA256:"SHA-256",SHA384:"SHA-384",SHA512:"SHA-512"}})(W||(W={}));class re{constructor(e){this.hash=e,this.Nm=new W(e).Nh}async with_key(e){return new re.Macops(await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:this.hash},!1,["sign"]))}}re.Macops=class{constructor(t){this.crypto_key=t}async sign(t){return new Uint8Array(await crypto.subtle.sign(this.crypto_key.algorithm.name,this.crypto_key,t))}async verify(t,e){return Je(e,await this.sign(t))}};class gt{constructor(e){this.hash=e,this.Nx=new re(e).Nm}async extract(e,i){return(await new re(this.hash).with_key(e)).sign(i)}async expand(e,i,r){const n=new W(this.hash).Nh,s=Math.ceil(r/n),o=new Uint8Array(s*n),c=await new re(this.hash).with_key(e);let h=new Uint8Array,l=0;for(let f=0;f<s;f++)h=await c.sign(B([h,i,Uint8Array.of(f+1)])),o.set(h,l),l+=n;return o.slice(0,r)}}const Ke={name:"scrypt",harden:t=>bt(t,new Uint8Array,{N:32768,r:8,p:1})};var ne;(function(t){t[t.OPAQUE_P256=3]="OPAQUE_P256",t[t.OPAQUE_P384=4]="OPAQUE_P384",t[t.OPAQUE_P521=5]="OPAQUE_P521"})(ne||(ne={}));class _t{constructor(e){this.opaqueID=e;let i=0;switch(e){case ne.OPAQUE_P256:i=K.OPRF_P256_SHA256;break;case ne.OPAQUE_P384:i=K.OPRF_P384_SHA384;break;case ne.OPAQUE_P521:i=K.OPRF_P521_SHA512;break;default:throw new Error("invalid opaque id")}this.constants={Nn:32,Nseed:32},this.prng=new wt,this.oprf=new Xe(i),this.hash=new W(this.oprf.hash),this.mac=new re(this.hash.name),this.kdf=new gt(this.hash.name),this.ake=new rt(this.oprf.id)}toString(){return`${ne[this.opaqueID]} = {OPRF: ${this.oprf.name}, Hash: ${this.hash.name}}`}}function St(t){return new _t(t)}class D{static check_string(e){if(typeof e=="string")return!0;throw new Error("string expected")}static check_uint8array(e){if(e instanceof Uint8Array)return!0;throw new Error("Uint8Array expected")}static check_uint8arrays(e){return e.every(this.check_uint8array)}static check_bytes_array(e){if(!Array.isArray(e)||!e.every(i=>Number.isInteger(i)&&i>=0&&i<=255))throw new Error("Array of byte-sized integers expected");return!0}static check_bytes_arrays(e){return e.every(this.check_bytes_array)}static sizeSerialized(e){throw new Error("child class must implement")}static checked_bytes_to_uint8array(e,i){this.check_bytes_array(i);const r=Uint8Array.from(i);return this.checked_object(e,r),r}static checked_object(e,i){j(i,this.sizeSerialized(e),this.name)}}class $ extends D{constructor(e,i,r){super(),this.nonce=j(i,e.constants.Nn),this.auth_tag=j(r,e.mac.Nm)}serialize(){return Array.from(B([this.nonce,this.auth_tag]))}static sizeSerialized(e){return e.constants.Nn+e.mac.Nm}static deserialize(e,i){const r=this.checked_bytes_to_uint8array(e,i);let n=0,s=e.constants.Nn;const o=r.slice(n,s);n=s,s+=e.mac.Nm;const c=r.slice(n,s);return new $(e,o,c)}}class Ae extends D{constructor(e,i){D.check_uint8array(i),super(),this.data=j(i,e.oprf.Noe)}serialize(){return Array.from(this.data)}static sizeSerialized(e){return e.oprf.Noe}static deserialize(e,i){const r=this.checked_bytes_to_uint8array(e,i),n=0,s=e.oprf.Noe,o=r.slice(n,s);return new Ae(e,o)}}class be extends D{constructor(e,i,r,n){D.check_uint8arrays([i,r]),super(),this.client_public_key=j(i,e.ake.Npk),this.masking_key=j(r,e.hash.Nh),this.envelope=n}serialize(){return Array.from(B([this.client_public_key,this.masking_key,Uint8Array.from(this.envelope.serialize())]))}static sizeSerialized(e){return e.ake.Npk+e.hash.Nh+$.sizeSerialized(e)}static deserialize(e,i){const r=this.checked_bytes_to_uint8array(e,i);let n=0,s=e.ake.Npk;const o=r.slice(n,s);n=s,s+=e.hash.Nh;const c=r.slice(n,s);n=s,s+=$.sizeSerialized(e);const h=r.slice(n,s),l=$.deserialize(e,Array.from(h));return new be(e,o,c,l)}static async createFake(e){const i=e.prng.random(e.constants.Nseed),{public_key:r}=await e.ake.deriveAuthKeyPair(new Uint8Array(i)),n=new Uint8Array(e.prng.random(e.hash.Nh)),s=$.deserialize(e,new Array($.sizeSerialized(e)).fill(0));return new be(e,r,n,s)}}class ae extends D{constructor(e,i){D.check_uint8array(i),super(),this.data=j(i,e.oprf.Noe)}serialize(){return Array.from(this.data)}static sizeSerialized(e){return e.oprf.Noe}static deserialize(e,i){const r=this.checked_bytes_to_uint8array(e,i),n=0,s=e.oprf.Noe,o=r.slice(n,s);return new ae(e,o)}}class oe extends D{constructor(e,i,r){D.check_uint8arrays([i,r]),super(),this.client_nonce=j(i,e.constants.Nn),this.client_keyshare=j(r,e.ake.Npk)}serialize(){return Array.from(B([this.client_nonce,this.client_keyshare]))}static sizeSerialized(e){return e.constants.Nn+e.ake.Npk}static deserialize(e,i){const r=this.checked_bytes_to_uint8array(e,i);let n=0,s=e.constants.Nn;const o=r.slice(n,s);n=s,s+=e.ake.Npk;const c=r.slice(n,s);return new oe(e,o,c)}}class ce extends D{constructor(e,i){D.check_uint8array(i),super(),this.client_mac=j(i,e.mac.Nm)}serialize(){return Array.from(this.client_mac.slice())}static sizeSerialized(e){return e.mac.Nm}static deserialize(e,i){const r=this.checked_bytes_to_uint8array(e,i),n=0,s=e.mac.Nm,o=r.slice(n,s);return new ce(e,o)}}class ke extends D{constructor(e,i){super(),this.request=e,this.auth_init=i}serialize(){return[...this.request.serialize(),...this.auth_init.serialize()]}static sizeSerialized(e){return ae.sizeSerialized(e)+oe.sizeSerialized(e)}static deserialize(e,i){this.checked_bytes_to_uint8array(e,i);let r=0,n=ae.sizeSerialized(e);const s=ae.deserialize(e,i.slice(r,n));r=n,n+=oe.sizeSerialized(e);const o=oe.deserialize(e,i.slice(r,n));return new ke(s,o)}}class Ee extends D{constructor(e){super(),this.auth_finish=e}serialize(){return this.auth_finish.serialize()}static sizeSerialized(e){return ce.sizeSerialized(e)}static deserialize(e,i){this.checked_bytes_to_uint8array(e,i);const r=0,n=Number(ce.sizeSerialized(e)),s=ce.deserialize(e,i.slice(r,n));return new Ee(s)}}class vt{constructor(e){this.config=e}async start(){const e=this.config.prng.random(this.config.constants.Nn),{private_key:i,public_key:r}=await this.config.ake.generateAuthKeyPair();return this.client_secret=new Uint8Array(i),new oe(this.config,new Uint8Array(e),new Uint8Array(r))}async finalize(e,i,r,n,s,o,c){if(typeof this.client_secret>"u")return new Error("ake3dhclient has not started yet");const h=tt(this.config,[{sk:this.client_secret,pk:o.auth_response.server_keyshare},{sk:this.client_secret,pk:n},{sk:i,pk:o.auth_response.server_keyshare}]),l=et(s,o,r,e,c),{Km2:f,Km3:u,session_key:d}=await it(this.config,h,l),y=await this.config.hash.sum(l);if(!await(await this.config.mac.with_key(f)).verify(y,o.auth_response.server_mac))return new Error("handshake error");const m=await this.config.hash.sum(B([l,o.auth_response.server_mac])),p=await(await this.config.mac.with_key(u)).sign(m);return{auth_finish:new ce(this.config,p),session_key:d}}}class Ne{constructor(e,i,r,n,s){this.server_public_key=j(i,e.ake.Npk),this.server_identity=n||i,this.client_identity=s||r}serialize(){return Array.from(B([this.server_public_key,ue(this.server_identity),ue(this.client_identity)]))}}async function Oe(t,e,i){const r=await t.kdf.expand(e,B([i,Uint8Array.from(M.AuthKey)]),t.hash.Nh),n=await t.kdf.expand(e,B([i,Uint8Array.from(M.ExportKey)]),t.hash.Nh),s=await t.kdf.expand(e,B([i,Uint8Array.from(M.PrivateKey)]),t.constants.Nseed),o=await t.ake.deriveAuthKeyPair(s);return{auth_key:r,export_key:n,client_ake_keypair:o}}async function xt(t,e,i,r,n){const s=new Uint8Array(t.prng.random(t.constants.Nn)),{auth_key:o,export_key:c,client_ake_keypair:h}=await Oe(t,e,s),{public_key:l}=h,f=new Ne(t,i,l,r,n),u=B([s,Uint8Array.from(f.serialize())]),d=await(await t.mac.with_key(o)).sign(u),y=new $(t,s,d),m=await t.kdf.expand(e,Uint8Array.from(M.MaskingKey),t.hash.Nh);return{envelope:y,client_public_key:l,masking_key:m,export_key:c}}async function At(t,e,i,r,n,s){const{auth_key:o,export_key:c,client_ake_keypair:h}=await Oe(t,i,e.nonce),{public_key:l}=h,f=new Ne(t,r,l,n,s),u=B([e.nonce,Uint8Array.from(f.serialize())]);return await(await t.mac.with_key(o)).verify(u,e.auth_tag)?{client_ake_keypair:h,export_key:c}:new Error("EnvelopeRecoveryError")}class kt{constructor(e,i=Ke){this.config=e,this.memHard=i}async createRegistrationRequest(e){const{blindedElement:i,blind:r}=await this.config.oprf.blind(e);return{request:new Ae(this.config,i),blind:r}}async finalizeRequest(e,i,r,n,s){const o=await this.config.oprf.finalize(e,i,r.evaluation),c=new Uint8Array(this.config.hash.Nh),h=await this.config.kdf.extract(c,B([o,this.memHard.harden(o)])),{envelope:l,client_public_key:f,masking_key:u,export_key:d}=await xt(this.config,h,r.server_public_key,n,s);return{record:new be(this.config,f,u,l),export_key:Array.from(d)}}async createCredentialRequest(e){const{blindedElement:i,blind:r}=await this.config.oprf.blind(e);return{request:new ae(this.config,i),blind:r}}async recoverCredentials(e,i,r,n,s){const o=await this.config.oprf.finalize(e,i,r.evaluation),c=new Uint8Array(this.config.hash.Nh),h=await this.config.kdf.extract(c,B([o,this.memHard.harden(o)])),l=await this.config.kdf.expand(h,Uint8Array.from(M.MaskingKey),this.config.hash.Nh),f=$.sizeSerialized(this.config),u=await this.config.kdf.expand(l,B([r.masking_nonce,Uint8Array.from(M.CredentialResponsePad)]),this.config.ake.Npk+f),d=We(u,r.masked_response),y=d.slice(0,this.config.ake.Npk),{Npk:m}=this.config.ake,p=d.slice(m,m+f),b=$.deserialize(this.config,Array.from(p)),w=await At(this.config,b,h,y,n,s);return w instanceof Error?w:{server_public_key:y,...w}}}class Q{constructor(e,i=Ke){this.config=e,this.status=Q.States.NEW,this.opaque_core=new kt(e,i),this.ake=new vt(this.config)}async registerInit(e){if(this.status!==Q.States.NEW)return new Error("client not ready");const i=new TextEncoder().encode(e),{request:r,blind:n}=await this.opaque_core.createRegistrationRequest(i);return this.blind=n,this.password=i,this.status=Q.States.REG_STARTED,r}async registerFinish(e,i,r){if(this.status!==Q.States.REG_STARTED||typeof this.password>"u"||typeof this.blind>"u")return new Error("client not ready");const n=new TextEncoder,s=i?n.encode(i):void 0,o=r?n.encode(r):void 0,c=await this.opaque_core.finalizeRequest(this.password,this.blind,e,s,o);return this.clean(),c}async authInit(e){if(this.status!==Q.States.NEW)return new Error("client not ready");const i=new TextEncoder().encode(e),{request:r,blind:n}=await this.opaque_core.createCredentialRequest(i),s=await this.ake.start(),o=new ke(r,s);return this.blind=n,this.password=i,this.ke1=o,this.status=Q.States.LOG_STARTED,o}async authFinish(e,i,r,n){if(this.status!==Q.States.LOG_STARTED||typeof this.password>"u"||typeof this.blind>"u"||typeof this.ke1>"u")return new Error("client not ready");const s=new TextEncoder,o=i?s.encode(i):void 0,c=r?s.encode(r):void 0,h=n?s.encode(n):new Uint8Array(0),l=await this.opaque_core.recoverCredentials(this.password,this.blind,e.response,o,c);if(l instanceof Error)return l;const{client_ake_keypair:f,server_public_key:u,export_key:d}=l,y=await this.ake.finalize(c||f.public_key,f.private_key,o||u,u,this.ke1,e,h);if(y instanceof Error)return y;const{auth_finish:m,session_key:p}=y,b=new Ee(m);return this.clean(),{ke3:b,session_key:Array.from(p),export_key:Array.from(d)}}clean(){this.status=Q.States.NEW,this.password=void 0,this.blind=void 0,this.ke1=void 0}}Q.States={NEW:0,REG_STARTED:1,LOG_STARTED:2};export{ne as O,Q as a,St as g};
